<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>软件列表</title>
    <script src="js/xlsx.full.min.js"></script>
    <style>
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        /* 修改消息提示样式，使其居中悬浮显示 */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 1000;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
        }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }

        /* 描述字段样式 */
        .description-cell {
            display: inline-block;
            width: 100%;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
            color: #007bff;
            /* 移除下划线 */
            text-decoration: none;
        }

        .description-cell:hover {
            color: #0056b3;
        }

        /* 空内容样式 */
        .description-cell.empty {
            color: inherit;
            text-decoration: none;
            cursor: default;
        }

        .description-cell.empty:hover {
            color: inherit;
        }

        /* 自定义tooltip样式 */
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            white-space: normal;
            word-wrap: break-word;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
        }

        /* 来源页面和下载链接列样式 */
        .source-url-cell, .download-link-cell {
            display: inline-block;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .source-url-cell {
            color: #007bff;
            text-decoration: underline;
        }
        
        .download-link-cell {
            position: relative;
            padding-right: 20px; /* 为复制图标留出空间 */
        }
        
        /* 复制图标样式 */
        .copy-icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='9' y='9' width='13' height='13' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'%3E%3C/path%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            cursor: pointer;
        }
        
        .download-link-cell:hover .copy-icon {
            stroke: #007bff;
        }

        /* 位宽标签样式 */
        .bitwidth-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .bitwidth-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            background-color: #17a2b8; /* 蓝绿色 */
            color: white;
        }

        /* 系统要求字段样式 */
        .sys-req-cell {
            display: inline-block;
            width: 100%;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
        }

        .sys-req-cell:hover {
            color: #0056b3;
        }

        /* 空内容样式 */
        .sys-req-cell.empty {
            color: inherit;
            text-decoration: none;
            cursor: default;
        }

        .sys-req-cell.empty:hover {
            color: inherit;
        }

        /* 分页控件样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        .pagination button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .pagination input {
            width: 60px;
            padding: 6px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .pagination span {
            margin: 0 5px;
        }

        /* 新增按钮样式 */
        .add-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }
        .add-button:hover {
            background-color: #218838;
        }
        
        /* 导出按钮样式 */
        .export-button {
            display: inline-block;
            margin-bottom: 20px;
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #17a2b8;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }
        .export-button:hover {
            background-color: #138496;
        }
        
        /* 工具栏样式 */
        .toolbar {
            display: flex;
            align-items: center;
        }

        /* 行业标签样式 */
        .industry-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .industry-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            color: white;
        }

        /* 四个行业大类的颜色定义 */
        .category-A { background-color: #FF6B6B; } /* 红色 */
        .category-B { background-color: #4ECDC4; } /* 青色 */
        .category-C { background-color: #45B7D1; } /* 蓝色 */
        .category-D { background-color: #96CEB4; } /* 绿色 */
        .category-default { background-color: #6c757d; } /* 默认灰色 */
        .category-E { background-color: #FFEAA7; color: #333; }
        .category-F { background-color: #DDA0DD; }
        .category-G { background-color: #FFB347; }
        .category-H { background-color: #98D8C8; }
        .category-I { background-color: #F7DC6F; color: #333; }
        .category-J { background-color: #BB8FCE; }
        .category-K { background-color: #F8C471; }

        /* 默认颜色 */
        .category-default { background-color: #6c757d; }

        /* 操作按钮样式 */
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background-color: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background-color: #0056b3;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-edit {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn-edit:hover {
            background-color: #0056b3;
        }

        .btn-delete {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        /* 确认对话框样式 */
        .confirm-dialog {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .confirm-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }

        .confirm-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .confirm-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .confirm-btn-cancel {
            background-color: #6c757d;
            color: white;
        }

        .confirm-btn-confirm {
            background-color: #dc3545;
            color: white;
        }

        /* 冻结列样式 */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .col-cpu-req {
            width: 120px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; /* 改为auto以更好地支持冻结列 */
            min-width: 1200px; /* 确保表格有足够的宽度 */
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        
        /* 冻结第一列 (ID) */
        .col-id {
            position: sticky;
            left: 0;
            background-color: #f2f2f2;
            z-index: 3;
        }
        
        /* 冻结第二列 (名称) */
        .col-name {
            position: sticky;
            left: 40px; /* 第一列的宽度 */
            background-color: #f2f2f2;
            z-index: 2;
        }
        
        /* 冻结倒数第三列 (软件大小) */
        .col-size {
            position: sticky;
            right: 270px; /* 倒数第二列宽度(150px) + 最后一列宽度(120px) */
            background-color: #f2f2f2;
            z-index: 2;
        }
        
        /* 冻结倒数第二列 (所属行业) */
        .col-industry {
            position: sticky;
            right: 120px; /* 最后一列的宽度 */
            background-color: #f2f2f2;
            z-index: 2;
        }
        
        /* 冻结最后一列 (操作) */
        .col-actions {
            position: sticky;
            right: 0;
            background-color: #f2f2f2;
            z-index: 3;
        }
        
        /* 确保特定列的样式优先级更高 */
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        /* 为需要换行的列添加更具体的选择器 */
        .col-name,
        .col-other-req {
            white-space: pre-wrap !important;
            word-wrap: break-word;
            max-width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="menu.html" class="back-link">← 返回菜单</a>
        <h1>工业软件列表</h1>
        <div class="toolbar">
            <a href="add_software.html" class="add-button">新增工业软件</a>
            <button id="exportButton" class="export-button">导出到Excel</button>
        </div>
        <div id="message" class="message"></div>
        <div class="table-container">
        <table id="softwareTable">
            <thead>
                <tr>
                    <th class="col-id" style="width: 50px;">ID</th>
                    <th class="col-name" style="width: 80px;">名称</th>
                    <th class="col-version" style="width: 80px;">版本</th>
                    <th class="col-country" style="width: 80px;">国家</th>
                    <th class="col-bitwidth" style="width: 80px;">位宽</th>
                    <th class="col-developer" style="width: 80px;">厂商</th>
                    <th class="col-description" style="width: 80px;">描述</th>
                    <th class="col-release-date" style="width: 80px;">发布日期</th>
                    <th class="col-status" style="width: 80px;">状态</th>
                    <th class="col-cpu-req" style="width: 120px;">CPU要求</th>
                    <th class="col-memory" style="width: 50px;">内存(GB)</th>
                    <th class="col-disk" style="width: 50px;">磁盘(GB)</th>
                    <th class="col-other-req" style="width: 120px;">其他要求</th>
                    <th class="col-created-at" style="width: 80px;">创建时间</th>
                    <th class="col-source-url" style="width: 80px;">来源页面</th>
                    <th class="col-download-link" style="width: 80px;">下载链接</th>
                    <th class="col-size" style="width: 50px;">软件大小</th>
                    <th class="col-industry" style="width: 150px;">所属行业</th>
                    <th class="col-actions" style="width: 120px;">操作</th>
                </tr>
            </thead>
            <tbody id="softwareTableBody"></tbody>
        </table>
        </div>

        <!-- 分页控件 -->
        <div class="pagination" id="pagination">
            <button id="firstPage">首页</button>
            <button id="prevPage">上一页</button>
            <span>第 <input type="number" id="pageInput" min="1" value="1"> 页</span>
            <span>/ 共 <span id="totalPages">1</span> 页</span>
            <button id="nextPage">下一页</button>
            <button id="lastPage">末页</button>
            <span>每页 <input type="number" id="pageSizeInput" min="1" max="100" value="20"> 条</span>
            <button id="goPage">跳转</button>
        </div>

        <!-- 删除确认对话框 -->
        <div id="confirmDialog" class="confirm-dialog">
            <div class="confirm-content">
                <h3>确认删除</h3>
                <p>您确定要删除这个软件吗？此操作不可撤销。</p>
                <div class="confirm-buttons">
                    <button id="cancelDelete" class="confirm-btn confirm-btn-cancel">取消</button>
                    <button id="confirmDelete" class="confirm-btn confirm-btn-confirm">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统要求详情模态框 -->
    <div id="sysReqModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 5px; width: 80%; max-width: 600px; position: relative;">
            <span id="closeSysReqModal" style="position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer;">&times;</span>
            <h3>系统要求</h3>
            <div id="modalSysReq" style="word-wrap: break-word; white-space: pre-wrap; max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/v1';
        let currentPage = 1;
        let pageSize = 20;
        let total = 0;
        let softwareIdToDelete = null;
        let targetDeveloperId = null;
        let newSoftwareId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            targetDeveloperId = urlParams.get('developerId');
            newSoftwareId = urlParams.get('newSoftwareId');

            setupPagination();

            // 如果有目标厂商ID，则需要找到该厂商所在的页面
            if (targetDeveloperId) {
                findPageForDeveloper(targetDeveloperId);
            }
            // 如果有新添加的软件ID，则需要找到该软件所在的页面
            else if (newSoftwareId) {
                findPageForNewSoftware(newSoftwareId);
            }
            // 否则按正常流程加载第一页
            else {
                fetchSoftwareList(currentPage, pageSize);
            }

            document.getElementById('cancelDelete').addEventListener('click', closeConfirmDialog);
            document.getElementById('confirmDelete').addEventListener('click', performDelete);
            setupModal();
            setupSysReqModal();
        });

        function setupPagination() {
            document.getElementById('firstPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    fetchSoftwareList(1, pageSize);
                }
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    fetchSoftwareList(currentPage - 1, pageSize);
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(total / pageSize);
                if (currentPage < totalPages) {
                    fetchSoftwareList(currentPage + 1, pageSize);
                }
            });

            document.getElementById('lastPage').addEventListener('click', () => {
                const totalPages = Math.ceil(total / pageSize);
                if (currentPage < totalPages) {
                    fetchSoftwareList(totalPages, pageSize);
                }
            });

            document.getElementById('goPage').addEventListener('click', () => {
                const pageInput = document.getElementById('pageInput');
                const page = parseInt(pageInput.value);
                const totalPages = Math.ceil(total / pageSize);

                if (page >= 1 && page <= totalPages) {
                    fetchSoftwareList(page, pageSize);
                } else {
                    showMessage(`请输入有效的页码 (1-${totalPages})`, 'error');
                }
            });

            document.getElementById('pageSizeInput').addEventListener('change', (e) => {
                const newSize = parseInt(e.target.value);
                if (newSize >= 1 && newSize <= 100) {
                    pageSize = newSize;
                    fetchSoftwareList(1, pageSize);
                } else {
                    showMessage('每页条数应在1-100之间', 'error');
                    e.target.value = pageSize;
                }
            });

            document.getElementById('pageInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('goPage').click();
                }
            });

            document.getElementById('pageSizeInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('pageSizeInput').dispatchEvent(new Event('change'));
                }
            });
        }

        async function fetchSoftwareList(page = 1, pageSize = 20) {
            try {
                const response = await fetch(`${API_BASE_URL}/software?page=${page}&page_size=${pageSize}`);
                if (!response.ok) throw new Error(`获取软件列表失败: ${response.status} ${response.statusText}`);

                const result = await response.json();
                const data = Array.isArray(result.items) ? result.items : [];
                total = result.total || 0;
                currentPage = result.page || page;

                updatePaginationControls();
                renderSoftwareTable(data);
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('获取软件列表错误:', error);
                renderSoftwareTable([]);
            }
        }

        // 查找指定厂商所在页面的函数
        async function findPageForDeveloper(developerId) {
            try {
                // 先获取第一页数据以确定总条数
                const response = await fetch(`${API_BASE_URL}/software?page=1&page_size=${pageSize}`);
                if (!response.ok) throw new Error(`获取软件列表失败: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                total = result.total || 0;
                
                // 计算总页数
                const totalPages = Math.ceil(total / pageSize);
                
                // 遍历所有页面查找目标厂商
                for (let page = 1; page <= totalPages; page++) {
                    const pageResponse = await fetch(`${API_BASE_URL}/software?page=${page}&page_size=${pageSize}`);
                    if (!pageResponse.ok) continue;
                    
                    const pageResult = await pageResponse.json();
                    const data = Array.isArray(pageResult.items) ? pageResult.items : [];
                    
                    // 检查当前页是否包含目标厂商
                    if (data.some(software => software.developerId == developerId)) {
                        // 找到目标厂商所在页面，加载该页面
                        fetchSoftwareList(page, pageSize);
                        return;
                    }
                }
                
                // 如果没找到，加载第一页
                fetchSoftwareList(1, pageSize);
            } catch (error) {
                console.error('查找厂商页面错误:', error);
                // 出错时加载第一页
                fetchSoftwareList(1, pageSize);
            }
        }
        
        // 添加查找新添加软件所在页面的函数
        async function findPageForNewSoftware(softwareId) {
            try {
                // 先获取第一页数据以确定总条数
                const response = await fetch(`${API_BASE_URL}/software?page=1&page_size=${pageSize}`);
                if (!response.ok) throw new Error(`获取软件列表失败: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                total = result.total || 0;
                
                // 计算总页数
                const totalPages = Math.ceil(total / pageSize);
                
                // 遍历所有页面查找新添加的软件
                for (let page = 1; page <= totalPages; page++) {
                    const pageResponse = await fetch(`${API_BASE_URL}/software?page=${page}&page_size=${pageSize}`);
                    if (!pageResponse.ok) continue;
                    
                    const pageResult = await pageResponse.json();
                    const data = Array.isArray(pageResult.items) ? pageResult.items : [];
                    
                    // 检查当前页是否包含新添加的软件
                    if (data.some(software => software.id == softwareId)) {
                        // 找到新软件所在页面，加载该页面
                        fetchSoftwareList(page, pageSize);
                        // 高亮显示新添加的软件
                        setTimeout(() => highlightNewSoftware(softwareId), 500);
                        return;
                    }
                }
                
                // 如果没找到，加载第一页
                fetchSoftwareList(1, pageSize);
            } catch (error) {
                console.error('查找新软件页面错误:', error);
                // 出错时加载第一页
                fetchSoftwareList(1, pageSize);
            }
        }
        
        // 添加高亮显示新添加软件的函数
        function highlightNewSoftware(softwareId) {
            const row = document.querySelector(`tr[data-id="${softwareId}"]`);
            if (row) {
                row.style.backgroundColor = '#ffffcc'; // 淡黄色背景
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 3秒后恢复原样式
                setTimeout(() => {
                    if (row) {
                        row.style.backgroundColor = '';
                    }
                }, 3000);
            }
        }

        function renderSoftwareTable(data) {
            const tableBody = document.getElementById('softwareTableBody');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="17" style="text-align: center;">暂无数据</td>';
                tableBody.appendChild(row);
                return;
            }

            data.forEach(software => {
                const id = software.id || '-';
                const nameEn = software.nameEn || 'default';
                const nameZh = software.nameZh || '-';
                const version = software.version || '-';
                const countryName = software.countryName || '未知';
                const developerName = software.developerName || '未知';
                const cpuReq = software.cpuReq || '-';
                const memoryMinGb = software.memoryMinGb || '-';
                const diskMinGb = software.diskMinGb || '-';
                const sysReqOther = software.sysReqOther || '-';
                const sourceUrl = software.sourceUrl || '-';
                const downloadLink = software.downloadLink || '-';

                // 处理描述字段 - 使用自定义tooltip显示完整内容
                const description = software.description || '-';
                const descriptionCell = description === '-' ?
                    `<span class="description-cell empty">-</span>` :
                    `<span class="description-cell" data-description="${description.replace(/"/g, '&quot;')}">${description.substring(0, 50)}${description.length > 50 ? '...' : ''}</span>`;

                let releaseDate = '-';
                if (software.releaseYear) {
                    if (software.releaseMonth && software.releaseDay) {
                        releaseDate = `${software.releaseYear}-${String(software.releaseMonth).padStart(2, '0')}-${String(software.releaseDay).padStart(2, '0')}`;
                    } else if (software.releaseMonth) {
                        releaseDate = `${software.releaseYear}-${String(software.releaseMonth).padStart(2, '0')}`;
                    } else {
                        releaseDate = software.releaseYear;
                    }
                }

                const statusMap = {
                    'active': '有效',
                    'inactive': '下架',
                    'testing': '测试中',
                    'discontinued': '已停产'
                };
                const status = statusMap[software.status] || software.status || '未知';

                const createdAt = formatDate(software.createdAt) || '-';

                let industryTags = '<div class="industry-tags">-</div>';
                if (software.industryDetails && software.industryDetails.length > 0) {
                    const tagsHtml = software.industryDetails.map(industry => {
                        const categoryClass = industry.categoryCode ?
                            `category-${industry.categoryCode}` : 'category-default';
                        return `<span class="industry-tag ${categoryClass}">${industry.subcategoryName || industry.subcategoryName || '未知行业'}</span>`;
                    }).join('');
                    industryTags = `<div class="industry-tags">${tagsHtml}</div>`;
                }

                // 位宽标签
                let bitWidthTags = '<div class="bitwidth-tags">-</div>';
                if (software.bitWidths && software.bitWidths.length > 0) {
                    const tagsHtml = software.bitWidths.map(bitWidth => {
                        return `<span class="bitwidth-tag">${bitWidth}</span>`;
                    }).join('');
                    bitWidthTags = `<div class="bitwidth-tags">${tagsHtml}</div>`;
                }

                const actions = `
                    <button class="edit-btn" data-id="${id}">修改</button>
                    <button class="delete-btn" data-id="${id}">删除</button>
                `;

                // 处理来源页面和下载链接字段
                const sourceUrlCell = sourceUrl === '-' ? 
                    '<td>-</td>' : 
                    `<td><a href="${sourceUrl}" target="_blank" class="source-url-cell" title="${sourceUrl}">${truncateText(sourceUrl, 20)}</a></td>`;
                
                const downloadLinkCell = downloadLink === '-' ? 
                    '<td>-</td>' : 
                    `<td><span class="download-link-cell" title="${downloadLink}">${truncateText(downloadLink, 20)}<span class="copy-icon" onclick="event.stopPropagation(); copyToClipboard('${downloadLink}')"></span></span></td>`;

                const row = document.createElement('tr');
                // 为每一行添加data-id属性，方便查找
                row.setAttribute('data-id', id);
                row.innerHTML = `
                    <td class="col-id">${id}</td>
                    <td class="col-name">${nameEn}</td>
                    <td class="col-version">${version}</td>
                    <td class="col-country">${countryName}</td>
                    <td class="col-bitwidth">${bitWidthTags}</td>
                    <td class="col-developer">${developerName}</td>
                    <td class="col-description">${descriptionCell}</td>
                    <td class="col-release-date">${releaseDate}</td>
                    <td class="col-status">${status}</td>
                    <td class="col-cpu-req">
                        ${cpuReq === '-' ? 
                        `<span class="sys-req-cell empty">-</span>` : 
                        `<span class="sys-req-cell" data-full-text="${cpuReq.replace(/"/g, '&quot;')}">${cpuReq.substring(0, 30)}${cpuReq.length > 30 ? '...' : ''}</span>`}
                    </td>
                    <td class="col-memory">${memoryMinGb}</td>
                    <td class="col-disk">${diskMinGb}</td>
                    <td class="col-other-req">
                        ${sysReqOther === '-' ? 
                        `<span class="sys-req-cell empty">-</span>` : 
                        `<span class="sys-req-cell" data-full-text="${sysReqOther.replace(/"/g, '&quot;')}">${sysReqOther.substring(0, 50)}${sysReqOther.length > 50 ? '...' : ''}</span>`}
                    </td>
                    <td class="col-created-at">${createdAt}</td>
                    ${sourceUrlCell}
                    ${downloadLinkCell}
                    <td class="col-size">${formatSize(software.sizeBytes)}</td>
                    <td class="col-industry">${industryTags}</td>
                    <td class="col-actions">${actions}</td>
                `;
                tableBody.appendChild(row);
            });

            // 绑定自定义tooltip事件
            bindTooltipEvents();

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const softwareId = this.getAttribute('data-id');
                    window.location.href = `edit_software.html?id=${softwareId}`;
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const softwareId = this.getAttribute('data-id');
                    const softwareName = this.closest('tr').querySelector('td:nth-child(3)').textContent;

                    if (confirm(`确定要删除软件 "${softwareName}" 吗？此操作不可恢复。`)) {
                        deleteSoftware(softwareId);
                    }
                });
            });

            document.querySelectorAll('.sys-req-cell:not(.empty)').forEach(span => {
                span.addEventListener('click', function() {
                    const sysReq = this.getAttribute('data-full-text');
                    document.getElementById('modalSysReq').textContent = sysReq;
                    document.getElementById('sysReqModal').style.display = 'block';
                });
            });
            document.querySelectorAll('.sys-req-cell:not(.empty)').forEach(span => {
                span.addEventListener('click', function() {
                    const sysReq = this.getAttribute('data-full-text');
                    document.getElementById('modalSysReq').textContent = sysReq;
                    document.getElementById('sysReqModal').style.display = 'block';
                });
            });
        }

        // 添加系统要求模态框关闭功能
        function setupSysReqModal() {
            const modal = document.getElementById('sysReqModal');
            const closeBtn = document.getElementById('closeSysReqModal');
            
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            }
            
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // 截断文本函数
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) {
                return text;
            }
            return text.substr(0, maxLength) + '...';
        }

        // 复制到剪贴板函数
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // 显示复制成功的提示
            showMessage('链接已复制到剪贴板', 'success');
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(total / pageSize);
            document.getElementById('pageInput').value = currentPage;
            document.getElementById('pageInput').min = 1;
            document.getElementById('pageInput').max = totalPages;
            document.getElementById('totalPages').textContent = totalPages || 1;
            document.getElementById('firstPage').disabled = currentPage <= 1;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
            document.getElementById('pageSizeInput').value = pageSize;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';

                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            } catch (error) {
                console.error('日期格式化错误:', error);
                return '-';
            }
        }

        function formatSize(sizeBytes) {
            if (!sizeBytes || sizeBytes <= 0) return '-';

            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = sizeBytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return size.toFixed(2) + ' ' + units[unitIndex];
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;

            // 显示消息
            messageEl.style.display = 'block';

            // 3秒后隐藏消息
            setTimeout(() => {
                messageEl.style.display = 'none';
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 3000);
        }

        function closeConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
            softwareIdToDelete = null;
        }

        async function performDelete() {
            if (!softwareIdToDelete) return;

            try {
                const response = await fetch(`${API_BASE_URL}/software/${softwareIdToDelete}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error(`删除软件失败: ${response.status} ${response.statusText}`);

                closeConfirmDialog();
                fetchSoftwareList(currentPage, pageSize);
                showMessage('软件删除成功', 'success');
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('删除软件错误:', error);
            }
        }

        async function deleteSoftware(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/software/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error(`删除软件失败: ${response.status} ${response.statusText}`);

                const result = await response.json();

                if (result.success) {
                    showMessage('软件删除成功', 'success');
                    fetchSoftwareList(currentPage, pageSize);
                } else {
                    showMessage(`删除失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('删除软件错误:', error);
            }
        }

        // 自定义tooltip功能
        function bindTooltipEvents() {
            const existingTooltip = document.getElementById('customTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // 创建tooltip元素
            const tooltip = document.createElement('div');
            tooltip.id = 'customTooltip';
            tooltip.className = 'tooltip';
            document.body.appendChild(tooltip);

            // 为所有描述字段绑定事件
            document.querySelectorAll('.description-cell:not(.empty)').forEach(span => {
                span.addEventListener('mouseenter', function(e) {
                    const description = this.getAttribute('data-description');
                    tooltip.textContent = description;
                    tooltip.style.display = 'block';

                    // 获取鼠标位置
                    const x = e.pageX;
                    const y = e.pageY;

                    // 设置tooltip位置
                    tooltip.style.left = (x + 10) + 'px';
                    tooltip.style.top = (y + 10) + 'px';
                });

                span.addEventListener('mousemove', function(e) {
                    // 跟随鼠标移动
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY + 10) + 'px';
                });

                span.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
            });
        }

        // 修改导出表格到Excel的函数
        async function exportTableToExcelFromRawData() {
            // 显示正在导出的消息
            showMessage('正在导出数据，请稍候...', 'success');

            try {
                // 获取总记录数
                const countResponse = await fetch(`${API_BASE_URL}/software?page=1&page_size=1`);
                if (!countResponse.ok) throw new Error(`获取软件总数失败: ${countResponse.status} ${countResponse.statusText}`);

                const countResult = await countResponse.json();
                const total = countResult.total || 0;

                // 分批获取所有数据
                const batchSize = 100; // 每批获取100条记录
                const totalPages = Math.ceil(total / batchSize);
                let allData = [];

                for (let page = 1; page <= totalPages; page++) {
                    const response = await fetch(`${API_BASE_URL}/software?page=${page}&page_size=${batchSize}`);
                    if (!response.ok) throw new Error(`获取软件列表失败: ${response.status} ${response.statusText}`);

                    const result = await response.json();
                    const data = Array.isArray(result.items) ? result.items : [];
                    allData = allData.concat(data);

                    // 更新进度提示
                    showMessage(`正在导出数据... (${Math.min(page * batchSize, total)}/${total})`, 'success');
                }

                // 准备导出数据
                const exportData = allData.map(software => {
                    // 处理日期格式
                    let releaseDate = '-';
                    if (software.releaseYear) {
                        if (software.releaseMonth && software.releaseDay) {
                            releaseDate = `${software.releaseYear}-${String(software.releaseMonth).padStart(2, '0')}-${String(software.releaseDay).padStart(2, '0')}`;
                        } else if (software.releaseMonth) {
                            releaseDate = `${software.releaseYear}-${String(software.releaseMonth).padStart(2, '0')}`;
                        } else {
                            releaseDate = software.releaseYear;
                        }
                    }

                    // 状态映射
                    const statusMap = {
                        'active': '有效',
                        'inactive': '下架',
                        'testing': '测试中',
                        'discontinued': '已停产'
                    };
                    const status = statusMap[software.status] || software.status || '未知';

                    // 行业标签
                    let industryTags = '-';
                    if (software.industryDetails && software.industryDetails.length > 0) {
                        industryTags = software.industryDetails.map(industry =>
                            (industry.categoryName || '') + ' - ' + (industry.subcategoryName || '未知行业')
                        ).join('; ');
                    }

                    // 位宽标签
                    let bitWidthTags = '-';
                    if (software.bitWidths && software.bitWidths.length > 0) {
                        bitWidthTags = software.bitWidths.join('; ');
                    }

                    // 安全处理可能为null的字段
                    const description = software.description || '-';
                    const cpuReq = software.cpuReq || '-';
                    const memoryMinGb = software.memoryMinGb !== undefined && software.memoryMinGb !== null ? software.memoryMinGb : '-';
                    const diskMinGb = software.diskMinGb !== undefined && software.diskMinGb !== null ? software.diskMinGb : '-';
                    const sysReqOther = software.sysReqOther || '-';
                    const sourceUrl = software.sourceUrl || '-';
                    const downloadLink = software.downloadLink || '-';

                    // 返回处理后的数据对象
                    return {
                        'ID': software.id || '-',
                        '名称': software.nameEn || '-',
                        '版本': software.version || '-',
                        '国家': software.countryName || '未知',
                        '位宽': bitWidthTags,
                        '厂商': software.developerName || '未知',
                        '描述': description,
                        '发布日期': releaseDate,
                        '状态': status,
                        'CPU要求': cpuReq,
                        '内存(GB)': memoryMinGb,
                        '磁盘(GB)': diskMinGb,
                        '其他要求': sysReqOther,
                        '来源页面': sourceUrl,
                        '下载链接': downloadLink,
                        '软件大小': formatSize(software.sizeBytes),
                        '所属行业': industryTags
                    };
                });

                // 使用SheetJS创建工作簿
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "工业软件列表");

                // 导出文件
                const now = new Date();
                const timestamp = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');

                XLSX.writeFile(wb, `工业软件列表_${timestamp}.xlsx`);

                // 显示导出成功的消息
                showMessage('导出成功！共导出 ' + allData.length + ' 条记录', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showMessage('导出失败: ' + error.message, 'error');
            }
        }
                
        // 导出按钮的事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('exportButton').addEventListener('click', exportTableToExcelFromRawData);
        });
    </script>
</body>
</html>