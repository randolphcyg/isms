<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作系统列表</title>
    <script src="js/config.js"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .message { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
        
        /* 分页控件样式 */
        .pagination { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-top: 20px; 
            gap: 10px;
        }
        .pagination button { 
            padding: 8px 12px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .pagination button:disabled { 
            background-color: #ccc; 
            cursor: not-allowed; 
        }
        .pagination input { 
            width: 60px; 
            padding: 6px; 
            text-align: center; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .pagination span { 
            margin: 0 5px; 
        }

        .col-index {
            position: sticky;
            left: 0;
            background-color: #f2f2f2;
            z-index: 10;
        }

        .col-name {
            position: sticky;
            left: 50px;
            background-color: #f2f2f2;
            z-index: 10;
        }

        .col-version {
            position: sticky;
            left: 250px;
            background-color: #f2f2f2;
            z-index: 10;
        }

        .col-architecture {
            position: sticky;
            left: 350px;
            background-color: #f2f2f2;
            z-index: 10;
        }

        .col-manufacturer {
            position: sticky;
            left: 450px;
            background-color: #f2f2f2;
            z-index: 10;
        }

        .col-actions {
            position: sticky;
            right: 0;
            background-color: #f2f2f2;
            z-index: 10;
        }
        
        /* 搜索框样式 */
        .search-box { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .search-box input, .search-box select { 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .search-box button { 
            padding: 8px 12px; 
            background-color: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        
        /* 新增按钮样式 */
        .add-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .add-button:hover {
            background-color: #218838;
        }
        
        /* 操作列样式 */
        .col-actions {
            white-space: nowrap;
            width: 1%;
        }
        
        .col-actions.edit-mode {
            display: flex;
            gap: 5px;
        }
        
        .btn-edit, .btn-save, .btn-cancel {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit {
            background-color: #007bff;
            color: white;
        }
        
        .btn-save {
            background-color: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
        
        /* 编辑输入框样式 */
        .edit-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        
        textarea.edit-input {
            resize: vertical;
            min-height: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="menu.html" class="back-link">← 返回菜单</a>
        <h1>操作系统列表</h1>
        <button class="add-button" onclick="addOS()">新增操作系统</button>
        <div id="message" class="message"></div>
        
        <!-- 搜索框 -->
        <div class="search-box">
            <input type="text" id="keywordInput" placeholder="搜索名称或版本">
            <input type="text" id="manufacturerInput" placeholder="按开发商筛选">
            <button id="searchBtn">搜索</button>
            <button id="resetBtn">重置</button>
        </div>
        
        <table id="osTable">
            <thead>
                <tr>
                    <th class="col-index">序号</th>
                    <th class="col-name">名称</th>
                    <th class="col-version">版本</th>
                    <th class="col-architecture">架构</th>
                    <th class="col-manufacturer">开发商</th>
                    <th class="col-release-year">发布年份</th>
                    <th class="col-actions">操作</th>
                </tr>
            </thead>
            <tbody id="osTableBody"></tbody>
        </table>
        
        <!-- 分页控件 -->
        <div class="pagination" id="pagination">
            <button id="firstPage">首页</button>
            <button id="prevPage">上一页</button>
            <span>第 <input type="number" id="pageInput" min="1" value="1"> 页</span>
            <span>/ 共 <span id="totalPages">1</span> 页</span>
            <button id="nextPage">下一页</button>
            <button id="lastPage">末页</button>
            <span>每页 <input type="number" id="pageSizeInput" min="1" max="100" value="20"> 条</span>
            <button id="goPage">跳转</button>
        </div>
    </div>

    <script>
        // 当前分页状态
        let currentPage = 1;
        let pageSize = 20;
        let total = 0;
        
        // 搜索条件
        let searchKeyword = '';
        let searchManufacturer = '';
        
        // 当前编辑行和数据
        let currentEditingRow = null;
        let currentEditingData = null;

        // 页面加载时获取操作系统列表
        document.addEventListener('DOMContentLoaded', function() {
            setupPagination();
            setupSearch();
            fetchOSList(currentPage, pageSize);
        });

        // 设置分页控件事件监听
        function setupPagination() {
            document.getElementById('firstPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    fetchOSList(1, pageSize);
                }
            });
            
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    fetchOSList(currentPage - 1, pageSize);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(total / pageSize);
                if (currentPage < totalPages) {
                    fetchOSList(currentPage + 1, pageSize);
                }
            });
            
            document.getElementById('lastPage').addEventListener('click', () => {
                const totalPages = Math.ceil(total / pageSize);
                if (currentPage < totalPages) {
                    fetchOSList(totalPages, pageSize);
                }
            });
            
            document.getElementById('goPage').addEventListener('click', () => {
                const pageInput = document.getElementById('pageInput');
                const page = parseInt(pageInput.value);
                const totalPages = Math.ceil(total / pageSize);
                
                if (page >= 1 && page <= totalPages) {
                    fetchOSList(page, pageSize);
                } else {
                    showMessage(`请输入有效的页码 (1-${totalPages})`, 'error');
                }
            });
            
            document.getElementById('pageSizeInput').addEventListener('change', (e) => {
                const newSize = parseInt(e.target.value);
                if (newSize >= 1 && newSize <= 100) {
                    pageSize = newSize;
                    fetchOSList(1, pageSize); // 重置到第一页
                } else {
                    showMessage('每页条数应在1-100之间', 'error');
                    e.target.value = pageSize;
                }
            });
            
            // 回车跳转页面
            document.getElementById('pageInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('goPage').click();
                }
            });
            
            // 回车设置每页条数
            document.getElementById('pageSizeInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('pageSizeInput').dispatchEvent(new Event('change'));
                }
            });
        }

        // 设置搜索控件事件监听
        function setupSearch() {
            document.getElementById('searchBtn').addEventListener('click', () => {
                searchKeyword = document.getElementById('keywordInput').value.trim();
                searchManufacturer = document.getElementById('manufacturerInput').value.trim();
                fetchOSList(1, pageSize); // 重置到第一页
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('keywordInput').value = '';
                document.getElementById('manufacturerInput').value = '';
                searchKeyword = '';
                searchManufacturer = '';
                fetchOSList(1, pageSize); // 重置到第一页
            });
            
            // 回车搜索
            document.getElementById('keywordInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('searchBtn').click();
                }
            });
            
            document.getElementById('manufacturerInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('searchBtn').click();
                }
            });
        }

        // 获取操作系统列表
        async function fetchOSList(page = 1, pageSize = 20) {
            try {
                // 构建查询参数
                let url = `${window.Config.API_BASE_URL}/os?page=${page}&page_size=${pageSize}`;
                if (searchKeyword) {
                    url += `&keyword=${encodeURIComponent(searchKeyword)}`;
                }
                if (searchManufacturer) {
                    url += `&manufacturer=${encodeURIComponent(searchManufacturer)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`获取操作系统列表失败: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                
                // 检查响应数据结构
                if (!result || typeof result !== 'object') {
                    throw new Error('服务器响应格式错误');
                }
                
                // 提取数据数组
                const data = Array.isArray(result.items) ? result.items : [];
                total = result.total || 0;
                currentPage = result.page || page;
                
                // 更新分页控件
                updatePaginationControls();
                
                // 渲染表格
                renderOSTable(data);
                
                // 显示成功消息
                showMessage(`成功加载 ${data.length} 条操作系统数据`, 'success');
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('获取操作系统列表错误:', error);
                
                // 渲染空表格
                renderOSTable([]);
            }
        }

        // 渲染操作系统表格
        function renderOSTable(data) {
            const tableBody = document.getElementById('osTableBody');
            tableBody.innerHTML = '';

            if (!data || data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center;">暂无数据</td>';
                tableBody.appendChild(row);
                return;
            }

            data.forEach((os, index) => {
                const serialNumber = (currentPage - 1) * pageSize + index + 1;
                // 数据存在性检查和默认值设置
                const id = os.id || '-';
                const name = os.name || '未设置';
                const version = os.version || '未设置';
                const architecture = os.architecture || '未知';
                const manufacturer = os.manufacturer || '未知';
                const releaseYear = os.releaseYear || '-';
                
                const row = document.createElement('tr');
                row.dataset.id = id;
                row.innerHTML = `
                    <td class="col-index">${serialNumber}</td>
                    <td class="col-name">${name}</td>
                    <td class="col-version">${version}</td>
                    <td class="col-architecture">${architecture}</td>
                    <td class="col-manufacturer">${manufacturer}</td>
                    <td class="col-release-year">${releaseYear}</td>
                    <td class="col-actions">
                        <button class="btn-edit" onclick="editOS(${id})">编辑</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 更新分页控件状态
        function updatePaginationControls() {
            const totalPages = Math.ceil(total / pageSize);
            
            // 更新页码输入框
            document.getElementById('pageInput').value = currentPage;
            document.getElementById('pageInput').min = 1;
            document.getElementById('pageInput').max = totalPages;
            
            // 更新总页数显示
            document.getElementById('totalPages').textContent = totalPages || 1;
            
            // 更新按钮状态
            document.getElementById('firstPage').disabled = currentPage <= 1;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
            
            // 更新每页条数输入框
            document.getElementById('pageSizeInput').value = pageSize;
        }

        // 格式化日期时间
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-'; // 无效日期
                
                // 使用中文格式化日期
                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            } catch (error) {
                console.error('日期格式化错误:', error);
                return '-'; // 格式化失败时返回默认值
            }
        }

        // 显示消息
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;

            // 3秒后自动清除消息
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 3000);
        }
        
        // 编辑操作系统
        function editOS(id) {
            // 如果正在编辑其他行，先取消编辑
            if (currentEditingRow) {
                cancelEdit();
            }
            
            // 找到要编辑的行
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
            
            // 保存当前数据
            currentEditingRow = row;
            currentEditingData = {
                name: row.querySelector('.col-name').textContent,
                version: row.querySelector('.col-version').textContent,
                architecture: row.querySelector('.col-architecture').textContent,
                manufacturer: row.querySelector('.col-manufacturer').textContent,
                releaseYear: row.querySelector('.col-release-year').textContent
            };
            
            // 获取行数据
            const name = currentEditingData.name;
            const version = currentEditingData.version;
            const architecture = currentEditingData.architecture;
            const manufacturer = currentEditingData.manufacturer;
            const releaseYear = currentEditingData.releaseYear === '-' ? '' : currentEditingData.releaseYear;
            
            // 创建架构选择下拉框
            const architectureOptions = ['x86', 'x64', 'arm32', 'arm64', 'ppc64le', 's390x', 'riscv64']
                .map(arch => `<option value="${arch}" ${arch === architecture ? 'selected' : ''}>${arch}</option>`) 
                .join('');
            
            // 转换行到编辑模式
            row.querySelector('.col-name').innerHTML = `<input type="text" class="edit-input" data-field="name" value="${name}">`;
            row.querySelector('.col-version').innerHTML = `<input type="text" class="edit-input" data-field="version" value="${version}">`;
            row.querySelector('.col-architecture').innerHTML = `<select class="edit-input" data-field="architecture">${architectureOptions}</select>`;
            row.querySelector('.col-manufacturer').innerHTML = `<input type="text" class="edit-input" data-field="manufacturer" value="${manufacturer}">`;
            row.querySelector('.col-release-year').innerHTML = `<input type="number" class="edit-input" data-field="releaseYear" value="${releaseYear}" min="1900" max="2030">`;
            
            // 更新操作列
            row.querySelector('.col-actions').innerHTML = `
                <button class="btn-save" onclick="saveEdit(${id})">保存</button>
                <button class="btn-cancel" onclick="cancelEdit()">取消</button>
            `;
            row.querySelector('.col-actions').classList.add('edit-mode');
        }
        
        // 保存编辑
        async function saveEdit(id) {
            if (!currentEditingRow) return;
            
            // 获取编辑后的数据
            const editedData = {
                name: currentEditingRow.querySelector('input[data-field="name"]').value,
                version: currentEditingRow.querySelector('input[data-field="version"]').value,
                architecture: currentEditingRow.querySelector('select[data-field="architecture"]').value,
                manufacturer: currentEditingRow.querySelector('input[data-field="manufacturer"]').value,
                releaseYear: parseInt(currentEditingRow.querySelector('input[data-field="releaseYear"]').value) || 0,
                description: '' // 操作系统API需要这个字段，但当前UI没有提供编辑
            };
            
            // 验证必填字段
            if (!editedData.name || !editedData.version || !editedData.architecture) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 发送更新请求
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/os/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(editedData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '更新操作系统失败');
                }
                
                const result = await response.json();
                
                // 更新成功后，更新表格显示
                currentEditingRow.querySelector('.col-name').textContent = result.name;
                currentEditingRow.querySelector('.col-version').textContent = result.version;
                currentEditingRow.querySelector('.col-architecture').textContent = result.architecture;
                currentEditingRow.querySelector('.col-manufacturer').textContent = result.manufacturer || '未知';
                currentEditingRow.querySelector('.col-release-year').textContent = result.releaseYear || '-';
                
                // 恢复操作列
                currentEditingRow.querySelector('.col-actions').innerHTML = `
                    <button class="btn-edit" onclick="editOS(${id})">编辑</button>
                `;
                currentEditingRow.querySelector('.col-actions').classList.remove('edit-mode');
                
                // 清除编辑状态
                currentEditingRow = null;
                currentEditingData = null;
                
                showMessage('操作系统更新成功', 'success');
            } catch (error) {
                console.error('更新操作系统失败:', error);
                showMessage('更新操作系统失败: ' + error.message, 'error');
            }
        }
        
        // 取消编辑
        function cancelEdit() {
            if (!currentEditingRow || !currentEditingData) return;
            
            // 恢复原始数据
            currentEditingRow.querySelector('.col-name').textContent = currentEditingData.name;
            currentEditingRow.querySelector('.col-version').textContent = currentEditingData.version;
            currentEditingRow.querySelector('.col-architecture').textContent = currentEditingData.architecture;
            currentEditingRow.querySelector('.col-manufacturer').textContent = currentEditingData.manufacturer;
            currentEditingRow.querySelector('.col-release-year').textContent = currentEditingData.releaseYear;
            
            // 恢复操作列
            const id = currentEditingRow.dataset.id;
            currentEditingRow.querySelector('.col-actions').innerHTML = `
                <button class="btn-edit" onclick="editOS(${id})">编辑</button>
            `;
            currentEditingRow.querySelector('.col-actions').classList.remove('edit-mode');
            
            // 清除编辑状态
            currentEditingRow = null;
            currentEditingData = null;
        }
        
        // 新增操作系统
        function addOS() {
            // 如果正在编辑其他行，先取消编辑
            if (currentEditingRow) {
                cancelEdit();
            }
            
            const tableBody = document.getElementById('osTableBody');
            
            // 创建新行
            const newRow = document.createElement('tr');
            newRow.dataset.id = 'new'; // 标记为新增行
            
            // 创建架构选择下拉框
            const architectureOptions = ['x86', 'x64', 'arm32', 'arm64', 'ppc64le', 's390x', 'riscv64']
                .map(arch => `<option value="${arch}">${arch}</option>`) 
                .join('');
            
            // 填充新行内容
            newRow.innerHTML = `
                <td class="col-index">-</td>
                <td class="col-name"><input type="text" class="edit-input" data-field="name" placeholder="请输入系统名称"></td>
                <td class="col-version"><input type="text" class="edit-input" data-field="version" placeholder="请输入系统版本"></td>
                <td class="col-architecture">
                    <select class="edit-input" data-field="architecture" onchange="handleArchitectureChange(this)">${architectureOptions}<option value="other">其他</option></select>
                    <input type="text" class="edit-input" data-field="newArchitecture" placeholder="请输入新架构" style="display: none; margin-top: 5px;">
                </td>
                <td class="col-manufacturer"><input type="text" class="edit-input" data-field="manufacturer" placeholder="请输入开发商"></td>
                <td class="col-release-year"><input type="number" class="edit-input" data-field="releaseYear" placeholder="发布年份" min="1900" max="2030"></td>
                <td class="col-actions edit-mode">
                    <button class="btn-save" onclick="saveNew()">保存</button>
                    <button class="btn-cancel" onclick="cancelAdd()">取消</button>
                </td>
            `;
            
            // 将新行插入到表格的第一行
            if (tableBody.firstChild) {
                tableBody.insertBefore(newRow, tableBody.firstChild);
            } else {
                tableBody.appendChild(newRow);
            }
            
            // 聚焦到第一个输入框
            newRow.querySelector('input[data-field="name"]').focus();
        }
        
        // 处理架构选择变化
        function handleArchitectureChange(selectElement) {
            const newRow = selectElement.closest('tr');
            const newArchitectureInput = newRow.querySelector('input[data-field="newArchitecture"]');
            
            if (selectElement.value === 'other') {
                newArchitectureInput.style.display = 'block';
                newArchitectureInput.required = true;
            } else {
                newArchitectureInput.style.display = 'none';
                newArchitectureInput.required = false;
            }
        }
        
        // 保存新增
        async function saveNew() {
            // 找到新增行
            const newRow = document.querySelector('tr[data-id="new"]');
            if (!newRow) return;
            
            // 获取新增的数据
            const architectureSelect = newRow.querySelector('select[data-field="architecture"]');
            const newArchitectureInput = newRow.querySelector('input[data-field="newArchitecture"]');
            
            // 确定架构值
            let architectureValue = '';
            if (architectureSelect.value === 'other') {
                architectureValue = newArchitectureInput.value;
            } else {
                architectureValue = architectureSelect.value;
            }
            
            const newData = {
                name: newRow.querySelector('input[data-field="name"]').value,
                version: newRow.querySelector('input[data-field="version"]').value,
                architecture: architectureValue,
                manufacturer: newRow.querySelector('input[data-field="manufacturer"]').value,
                releaseYear: parseInt(newRow.querySelector('input[data-field="releaseYear"]').value) || 0,
                description: '' // 操作系统API需要这个字段
            };
            
            // 验证必填字段
            if (!newData.name || !newData.version || !newData.architecture) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 发送创建请求
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/os`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '创建操作系统失败');
                }
                
                const result = await response.json();
                
                // 创建成功后，更新表格显示
                newRow.dataset.id = result.id;
                newRow.querySelector('.col-name').textContent = result.name;
                newRow.querySelector('.col-version').textContent = result.version;
                newRow.querySelector('.col-architecture').textContent = result.architecture;
                newRow.querySelector('.col-manufacturer').textContent = result.manufacturer || '未知';
                newRow.querySelector('.col-release-year').textContent = result.releaseYear || '-';
                
                // 更新操作列
                newRow.querySelector('.col-actions').innerHTML = `
                    <button class="btn-edit" onclick="editOS(${result.id})">编辑</button>
                `;
                newRow.querySelector('.col-actions').classList.remove('edit-mode');
                
                showMessage('操作系统创建成功', 'success');
                
                // 更新分页信息
                total++;
                const totalPages = Math.ceil(total / pageSize);
                updatePaginationControls();

                // 重新加载数据以显示正确的序号
                fetchOSList(currentPage, pageSize);
            } catch (error) {
                console.error('创建操作系统失败:', error);
                showMessage('创建操作系统失败: ' + error.message, 'error');
            }
        }
        
        // 取消新增
        function cancelAdd() {
            // 找到新增行
            const newRow = document.querySelector('tr[data-id="new"]');
            if (!newRow) return;
            
            // 移除新增行
            newRow.remove();
        }
    </script>
</body>
</html>