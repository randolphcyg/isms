<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">工业软件管理</title>
    <script src="js/config.js"></script>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }

        /* 修改基础label样式，使其更突出 */
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; /* 加粗字体 */
            font-size: 16px; /* 增大字号 */
            color: #333; /* 设置深色字体 */
        }

        /* 可搜索下拉框样式 */
        .searchable-select {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .select-wrapper {
            display: none;
        }
        
        .options-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .options-dropdown.show {
            display: block;
        }
        
        .option-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .option-item:hover {
            background-color: #f5f5f5;
        }
        
        .option-item.selected {
            background-color: #007bff;
            color: white;
        }

        /* 增强form-section的legend样式 */
        .form-section legend {
            font-weight: bold;
            padding: 5px 15px; /* 增加内边距 */
            width: auto;
            font-size: 18px; /* 增大字号 */
            color: #007bff; /* 设置蓝色字体 */
            border: 2px solid #007bff; /* 添加蓝色边框 */
            border-radius: 4px; /* 圆角边框 */
            background-color: #f8f9fa; /* 背景色 */
        }

        .form-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-section legend {
            font-weight: bold;
            padding: 0 10px;
            width: auto;
        }
        
        .form-section:last-child {
            margin-bottom: 0;
        }
        
        /* 更多信息部分的分割线 */
        .form-section:nth-last-child(2) {
            border-bottom: 2px solid #007bff;
        }

        /* 同行布局样式 */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        label { display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        .cancel-btn { background-color: #6c757d; }
        .cancel-btn:hover { background-color: #5a6268; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        .message { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .size-group { display: flex; gap: 10px; }
        .size-group input { flex: 3; }
        .size-group select { flex: 1; }

        .date-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .date-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .industry-group { margin-bottom: 10px; }
        .subcategory-container { margin-top: 10px; display: none; }
        .subcategory-checkboxes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .subcategory-checkboxes label { display: flex; align-items: center; font-weight: normal; }
        .subcategory-checkboxes input { margin-right: 5px; }
        
        /* 行业小类标签样式 */
        .subcategory-label {
            display: inline-block;
            width: calc(50% - 10px);
            margin-right: 10px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 在较小屏幕上每行显示一个 */
        @media (max-width: 768px) {
            .subcategory-label {
                width: 100%;
                margin-right: 0;
            }
        }
        
        /* 行业分类标签样式 */
        .industry-tags-container {
            margin-top: 10px;
            min-height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        .industry-tag {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
        }

        .industry-tag .remove-tag {
            margin-left: 5px;
            cursor: pointer;
        }
        
        /* 行业分类树状选择器样式 */
        .tree-selector {
            position: relative;
            width: 100%;
        }
        
        .tree-selector-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-color: white;
        }
        
        .tree-selector-input:hover {
            border-color: #007bff;
        }

        .tree-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 600px;
            overflow-y: auto;
            display: none;
            max-width: 700px;
        }
        
        .tree-selector-dropdown.show {
            display: block;
        }
        
        /* 树节点样式 */
        .tree-node {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .tree-node:hover {
            background-color: #f5f5f5;
        }
        
        /* 用颜色区分展开/收起状态 */
        .tree-node.parent > .node-content::before {
            content: "▶ ";
            color: #999;
            transition: transform 0.2s;
        }
        
        .tree-node.parent.expanded > .node-content::before {
            content: "▼ ";
            color: #007bff;
        }
        
        /* 大类和小类的颜色区分 */
        .tree-node.parent {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .tree-node-children .tree-node {
            background-color: white;
            font-weight: normal;
        }
        
        .tree-node-children {
            padding-left: 20px;
            display: none;
        }
        
        .tree-node-children.show {
            display: block;
        }
        
        /* 小类两列布局 */
        .subcategory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .industry-quick-btn {
            background-color: #f0f8ff;
            border: 1px solid #4CAF50;
            color: #4CAF50;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .industry-quick-btn:hover {
            background-color: #4CAF50;
            color: white;
        }

        /* 已选择的行业标签样式 */
        .selected-industries-container {
            margin-bottom: 10px;
            min-height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: #f9f9f9;
        }
        
        .selected-industry-tag {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
        }

        .selected-industry-tag .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .placeholder-text {
            color: #999;
            font-style: italic;
        }
        
        .tree-node input[type="checkbox"] {
            margin-right: 8px;
        }

        /* 位宽标签样式 */
        .bit-width-tag {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px 2px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .bit-width-tag:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .bit-width-tag.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .os-controls {
            margin-bottom: 10px;
        }

        .os-control-btn {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
            padding: 8px 12px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 8px;
        }

        /* 添加清空按钮的特殊样式 */
        .clear-os-btn {
            background-color: #dc3545; /* 红色背景 */
            border: 1px solid #dc3545;
        }

        .win-os-btn {
            background-color: #7892e8;
            border: 1px solid #7892e8;
        }

        .linux-os-btn {
            background-color: #7892e8;
            border: 1px solid #7892e8;
        }
        
        .only-u-os-btn {
            background-color: #5acb94;
            border: 1px solid #5acb94;
        }

        .scope-os-btn {
            background-color: #35b7de; 
            border: 1px solid #35b7de;
        }

        .os-control-btn:hover {
            background-color: #0056b3;
        }

        /* 操作系统选择框选中项样式 */
        #osIds option:checked {
            background-color: #007bff;
            color: white;
        }

        .os-columns {
            display: flex;
            gap: 20px;
        }

        .os-column {
            flex: 1;
            border-right: 1px solid #ddd; /* 添加右边框 */
            padding-right: 20px; /* 添加右边距 */
        }

        /* 移除最后一个列的右边框和右边距 */
        .os-column:last-child {
            border-right: none;
            padding-right: 0;
        }

        .os-column h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        /* 保持原有的操作系统选中项样式 */
        #osIds option:checked, #windowsOSIds option:checked, #otherOSIds option:checked {
            background-color: #007bff;
            color: white;
        }
        </style>
</head>
<body>
    <div class="container">
        <a href="#" id="backLink" class="back-link">← 返回软件列表</a>
        <h1 id="formTitle">工业软件管理</h1>
        <form id="softwareForm">
        <!-- 基础信息 -->
            <fieldset class="form-section">
                <legend>基础信息</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nameEn">软件英文名称*</label>
                        <input type="text" id="nameEn" required>
                    </div>
                    <div class="form-group">
                        <label for="nameZh">软件中文名称</label>
                        <input type="text" id="nameZh">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="version">版本*</label>
                        <input type="text" id="version" required>
                    </div>
                    
                    <div class="form-group">
                        <label>发布日期</label>
                        <div class="date-group">
                            <input type="number" id="releaseYear" placeholder="年(YYYY)" min="1900" max="2100" style="width: 100px;">
                            <input type="number" id="releaseMonth" placeholder="月(MM)" min="1" max="12" style="width: 80px;">
                            <input type="number" id="releaseDay" placeholder="日(DD)" min="1" max="31" style="width: 80px;">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="manufacturer">厂商*</label>
                        <div class="searchable-select">
                            <input type="text" id="manufacturerSearch" placeholder="输入厂商名称搜索..." class="search-input">
                            <div class="select-wrapper">
                                <select id="manufacturer" required>
                                    <option value="">请选择厂商</option>
                                </select>
                            </div>
                            <div id="manufacturerOptions" class="options-dropdown">
                                <!-- 动态生成的选项将在这里显示 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="sizeValue">软件大小</label>
                        <div class="size-group">
                            <input type="number" id="sizeValue" step="0.01" placeholder="请输入软件大小">
                            <select id="sizeUnit">
                                <option value="GB">GB</option>
                                <option value="MB">MB</option>
                                <option value="KB">KB</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">描述</label>
                    <textarea id="description" rows="4"></textarea>
                </div>
            </fieldset>
            
            <fieldset class="form-section">
                <legend>系统要求</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cpuReq">处理器要求</label>
                        <input type="text" id="cpuReq">
                    </div>
                    <div class="form-group">
                        <label for="memoryMin">最小内存(GB)</label>
                        <input type="number" id="memoryMin" step="0.1" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="diskMin">最小磁盘空间(GB)</label>
                        <input type="number" id="diskMin" step="0.1" min="0">
                    </div>
                </div>

                <div>
                    <div class="form-group">
                        <label for="sysReqOther">其他系统要求</label>
                        <textarea id="sysReqOther" rows="4"></textarea>
                    </div>
                </div>

                <!-- 位宽字段 -->
                <div class="form-group">
                    <label>支持的位宽</label>
                    <div id="bitWidthTags">
                        <span class="bit-width-tag" data-value="8bit">8bit</span>
                        <span class="bit-width-tag" data-value="16bit">16bit</span>
                        <span class="bit-width-tag" data-value="32bit">32bit</span>
                        <span class="bit-width-tag" data-value="64bit">64bit</span>
                        <span class="bit-width-tag" data-value="128bit">128bit</span>
                        <span class="bit-width-tag" data-value="256bit">256bit</span>
                        <span class="bit-width-tag" data-value="512bit">512bit</span>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="form-section">
            <legend>行业与操作系统</legend>
            <div class="form-group">
                <label for="industryCategory">行业分类*</label>
                
                <!-- 已选择的行业标签和按钮 -->
                <div class="industry-selection-header">
                    <div id="selectedIndustriesContainer" class="selected-industries-container">
                        <div class="placeholder-text">已选择所属行业</div>
                    </div>
                    <div class="industry-buttons">
                        <button type="button" class="industry-select-btn" id="industryTreeSelector">选择行业分类</button>
                        <button type="button" class="clear-industry-btn clear-os-btn" id="clearIndustryBtn" style="margin-top: 8px;">清空</button>
                    </div>
                    <div class="industry-buttons" style="margin-top: 8px;">
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="33">金属制品业(C33)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="34">通用设备制造业(C34)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="35">专用设备制造业(C35)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="36">电气机械和器材制造业(C36)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="37">机械和工具制造业(C37)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="38">电气机械和器材制造业(C38)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="39">计算机、通信和其他(C39)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="C" data-subcategory-code="40">仪器仪表制造业(C40)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="E" data-subcategory-code="47">房屋建筑业(E47)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="E" data-subcategory-code="48">土木工程建筑业(E48)</button>
                        <button type="button" class="industry-quick-btn" data-category-code="E" data-subcategory-code="49">建筑安装业(E49)</button>
                    </div>
                </div>
                
                <!-- 树状选择器 -->
                <div class="tree-selector">
                    <div class="tree-selector-dropdown" id="industryTreeDropdown">
                        <div id="industryTreeContent">
                            <!-- 树状结构将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
                
            <div class="form-group">
                <label for="osIds">操作系统</label>
                <div class="os-columns">
                    <div class="os-column">
                        <div>Windows</div>
                         <div class="os-controls">
                            <button type="button" id="clearOSBtn" class="os-control-btn  clear-os-btn">清空</button>
                            <button type="button" id="selectAllWindowsBtn" class="os-control-btn scope-os-btn">所有</button>
                            <button type="button" id="selectWin32Btn" class="os-control-btn scope-os-btn">x86</button>
                            <button type="button" id="selectWin64Btn" class="os-control-btn scope-os-btn">x64</button>
                            <button type="button" id="selectWinXPAndAboveBtn" class="btn btn-secondary btn-sm scope-os-btn">XP及以上</button>
                        </div>
                        <div class="os-controls">
                            <button type="button" id="selectWinNTBtn" class="os-control-btn">NT</button>
                            <button type="button" id="selectWin95Btn" class="os-control-btn">95</button>
                            <button type="button" id="selectWin98Btn" class="os-control-btn">98</button>
                            <button type="button" id="selectWin2000Btn" class="os-control-btn">2000</button>
                            <button type="button" id="selectWinXPBtn" class="os-control-btn">XP</button>
                            <button type="button" id="selectWinVistaBtn" class="os-control-btn">Vista</button>
                        </div>
                        <div class="os-controls">
                            <button type="button" id="selectWin7Btn" class="os-control-btn win-os-btn">7</button>
                            <button type="button" id="selectWin8Btn" class="os-control-btn win-os-btn">8</button>
                            <button type="button" id="selectWin10Btn" class="os-control-btn win-os-btn">10</button>
                            <button type="button" id="selectWin11Btn" class="os-control-btn win-os-btn">11</button>
                        </div>
                        <div class="os-controls">
                            <button type="button" id="clearX64Btn" class="os-control-btn  only-u-os-btn">只要x86</button>
                            <button type="button" id="clearX86Btn" class="os-control-btn  only-u-os-btn">只要x64</button>
                        </div>
                        <select id="windowsOSIds" multiple style="height: 300px; width: 100%;"></select>
                    </div>

                    <div class="os-column">
                        <div>其他系统</div>
                        <div class="os-controls" style="margin-top: 8px;">
                            <button type="button" id="clearOSBtn" class="os-control-btn  clear-os-btn">清空</button>
                            <button type="button" id="selectAllLinuxBtn" class="os-control-btn scope-os-btn">所有Linux</button>
                        </div>
                        <div class="os-controls" style="margin-top: 8px;">
                            <button type="button" id="selectUbuntuBtn" class="os-control-btn linux-os-btn">Ubuntu</button>
                            <button type="button" id="selectCentOSBtn" class="os-control-btn linux-os-btn">CentOS</button>
                            <button type="button" id="selectFedoraBtn" class="os-control-btn linux-os-btn">Fedora</button>
                            <button type="button" id="selectRedHatBtn" class="os-control-btn linux-os-btn">Red Hat</button>
                            <button type="button" id="selectDebianBtn" class="os-control-btn linux-os-btn">Debian</button>
                            <button type="button" id="selectSUSEBtn" class="os-control-btn linux-os-btn">SUSE</button>
                        </div>

                        <div class="os-controls" style="margin-top: 8px;">
                            <button type="button" id="selectMacOSBtn" class="os-control-btn">Mac OS</button>
                            <button type="button" id="selectAndroidBtn" class="os-control-btn">Android</button>
                            <button type="button" id="selectAccessBtn" class="os-control-btn">Access</button>
                        </div>
                
                        <select id="otherOSIds" multiple style="height: 355px; width: 100%;"></select>
                    </div>
                </div>
                <small>按住Ctrl键(Windows)或Command键(Mac)可多选</small><br>
                <small>点击“清空”可清空所有已选择的操作系统</small><br>
                <small>点击“只要x86”可取消已选择x86操作系统</small>
            </div>

            </fieldset>
            
            <!-- 更多信息 -->
            <fieldset class="form-section">
                <legend>更多信息</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceUrl">来源页面</label>
                        <input type="text" id="sourceUrl">
                    </div>
                    <div class="form-group">
                        <label for="downloadLink">下载链接</label>
                        <input type="text" id="downloadLink">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="deploymentMethod">部署方式</label>
                        <input type="text" id="deploymentMethod">
                    </div>
                    <div class="form-group">
                        <label for="complianceInfo">合规性信息</label>
                        <textarea id="complianceInfo" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="securityInfo">安全信息</label>
                        <textarea id="securityInfo" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="intellectualProperty">知识产权信息</label>
                        <textarea id="intellectualProperty" rows="3"></textarea>
                    </div>
                </div>
            </fieldset>
            
            <div class="form-group">
                <label for="status">状态*</label>
                <select id="status" required>
                    <option value="active" selected>有效</option>
                    <option value="inactive">下架</option>
                    <option value="testing">测试中</option>
                    <option value="discontinued">已停产</option>
                </select>
            </div>
            
            <div class="button-group">
                <button type="submit" id="submitBtn">提交</button>
                <button type="button" id="cancelBtn" class="cancel-btn">取消</button>
            </div>
            <div id="message" class="message"></div>
        </form>
    </div>

    <script>
        // 保存已选择的行业分类
        let selectedIndustries = new Map(); // Map<categoryCode, {categoryName, subcategories: Map<subcategoryId, subcategoryName>}>
        
        // 保存行业分类数据
        let industryCategories = [];
        let industrySubcategories = new Map(); // Map<categoryCode, subcategories[]>
        
        // 保存软件ID
        let softwareId = null;
        
        // 添加操作系统相关变量
        let osList = []; // 存储操作系统列表
        
        // 页面操作模式 ('add' 或 'edit')
        let formMode = 'add';

        // 获取操作系统列表
        async function fetchOSList() {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/os?page=1&page_size=100`);
                if (!response.ok) throw new Error('获取操作系统列表失败');
                
                const result = await response.json();
                osList = Array.isArray(result.items) ? result.items : [];
                renderOSOptions();
            } catch (error) {
                console.error('获取操作系统列表错误:', error);
            }
        }

        // 渲染操作系统选项
        function renderOSOptions() {
            const windowsSelect = document.getElementById('windowsOSIds');
            const otherSelect = document.getElementById('otherOSIds');
            if (!windowsSelect || !otherSelect) return;
            
            // 清空现有选项
            windowsSelect.innerHTML = '';
            otherSelect.innerHTML = '';
            
            // 分离Windows和其他系统
            const windowsOS = osList.filter(os => os.name.toLowerCase().includes('windows'));
            const otherOS = osList.filter(os => !os.name.toLowerCase().includes('windows'));
            
            // 添加Windows系统选项
            windowsOS.forEach(os => {
                const option = document.createElement('option');
                option.value = os.id;
                option.textContent = `${os.name} ${os.version} (${os.architecture})`;
                windowsSelect.appendChild(option);
            });
            
            // 添加其他系统选项
            otherOS.forEach(os => {
                const option = document.createElement('option');
                option.value = os.id;
                option.textContent = `${os.name} ${os.version} (${os.architecture})`;
                otherSelect.appendChild(option);
            });
        }
        
        // 页面加载时获取厂商列表
        document.addEventListener('DOMContentLoaded', async function() {
            // 添加位宽标签点击事件
            document.getElementById('bitWidthTags').addEventListener('click', function(e) {
                if (e.target.classList.contains('bit-width-tag')) {
                    e.target.classList.toggle('selected');
                }
            });

            // 从URL获取软件ID
            const urlParams = new URLSearchParams(window.location.search);
            softwareId = urlParams.get('id');

            // 确定操作模式
            formMode = softwareId ? 'edit' : 'add';
            
            // 设置页面标题和按钮文本
            document.getElementById('pageTitle').textContent = formMode === 'add' ? '新增工业软件' : '编辑工业软件';
            document.getElementById('formTitle').textContent = formMode === 'add' ? '新增工业软件' : '编辑工业软件';
            document.getElementById('submitBtn').textContent = formMode === 'add' ? '添加' : '更新';

            // 获取厂商列表
            await fetchManufacturers();
            // 获取行业分类数据
            await fetchIndustryCategories();

            // 获取操作系统列表
            await fetchOSList();

            // 如果是编辑模式，加载软件数据
            if (formMode === 'edit') {
                if (!softwareId) {
                    showMessage('软件ID未找到，请从软件列表页面进入编辑页面', 'error');
                    return;
                }
                await loadSoftwareData(softwareId);
            }

            // 绑定事件
            document.getElementById('softwareForm').addEventListener('submit', handleSubmit);
            document.getElementById('cancelBtn').addEventListener('click', handleCancel);
            
            // 添加厂商选择变化事件监听器
            document.getElementById('manufacturer').addEventListener('change', handleManufacturerChange);
            
            // 行业分类相关事件监听
            document.getElementById('industryTreeSelector').addEventListener('click', toggleIndustryTree);
            document.getElementById('clearIndustryBtn').addEventListener('click', clearIndustrySelection);
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('industryTreeDropdown');
                const selector = document.getElementById('industryTreeSelector');
                
                if (!selector.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });

        // 添加全局变量来存储厂商数据
        let manufacturerData = [];
        let filteredManufacturers = [];
        
        // 获取厂商列表
        async function fetchManufacturers() {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/developers?page=1&page_size=100`);
                if (!response.ok) throw new Error('获取厂商列表失败');
                const result = await response.json();
                
                manufacturerData = Array.isArray(result.items) ? result.items : [];
                filteredManufacturers = [...manufacturerData]; // 初始化筛选列表
                
                const select = document.getElementById('manufacturer');
                const optionsContainer = document.getElementById('manufacturerOptions');
                
                // 根据操作模式设置默认选项
                if (formMode === 'add') {
                    select.innerHTML = '<option value="1" selected>未知开发商</option>';
                    document.getElementById('manufacturerSearch').value = '未知开发商';
                } else {
                    select.innerHTML = '<option value="">请选择厂商</option>';
                }
                
                // 清空选项容器
                optionsContainer.innerHTML = '';
                
                manufacturerData.forEach(manufacturer => {
                    // 在新增模式下，跳过ID为1的厂商（因为已作为默认选项添加）
                    if (formMode === 'add' && manufacturer.id === 1) return;
                    
                    const option = document.createElement('option');
                    option.value = manufacturer.id;
                    option.textContent = manufacturer.nameZh && manufacturer.nameEn ? 
                        `${manufacturer.nameZh}(${manufacturer.nameEn})` : 
                        (manufacturer.nameZh || manufacturer.nameEn || manufacturer.name || '未知厂商');
                    select.appendChild(option);
                    
                    // 为自定义下拉框创建选项
                    const optionItem = document.createElement('div');
                    optionItem.className = 'option-item';
                    optionItem.dataset.value = manufacturer.id;
                    optionItem.textContent = manufacturer.nameZh && manufacturer.nameEn ? 
                        `${manufacturer.nameZh}(${manufacturer.nameEn})` : 
                        (manufacturer.nameZh || manufacturer.nameEn || manufacturer.name || '未知厂商');
                    optionsContainer.appendChild(optionItem);
                });
                
                // 绑定自定义下拉框事件
                bindCustomSelectEvents();
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('获取厂商列表错误:', error);
            }
        }
        
        // 绑定自定义下拉框事件
        function bindCustomSelectEvents() {
            const searchInput = document.getElementById('manufacturerSearch');
            const optionsContainer = document.getElementById('manufacturerOptions');
            const select = document.getElementById('manufacturer');
            
            // 点击搜索框显示选项
            searchInput.addEventListener('focus', function() {
                filterManufacturers('');
                optionsContainer.classList.add('show');
            });
            
            // 输入时筛选选项
            searchInput.addEventListener('input', function() {
                filterManufacturers(this.value);
                optionsContainer.classList.add('show');
            });
            
            // 点击选项选择厂商
            optionsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('option-item')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;
                    
                    // 更新隐藏的select元素
                    select.value = value;
                    
                    // 更新搜索框显示
                    searchInput.value = text;
                    
                    // 隐藏选项列表
                    optionsContainer.classList.remove('show');
                    
                    // 触发change事件
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            // 点击其他地方隐藏选项
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !optionsContainer.contains(e.target)) {
                    optionsContainer.classList.remove('show');
                }
            });
            
            // 为选项添加键盘导航
            searchInput.addEventListener('keydown', function(e) {
                const options = optionsContainer.querySelectorAll('.option-item');
                if (options.length === 0) return;
                
                const currentIndex = Array.from(options).findIndex(option => option.classList.contains('selected'));
                let newIndex = currentIndex;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        newIndex = currentIndex < options.length - 1 ? currentIndex + 1 : 0;
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        newIndex = currentIndex > 0 ? currentIndex - 1 : options.length - 1;
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentIndex >= 0) {
                            options[currentIndex].click();
                        }
                        return;
                    case 'Escape':
                        optionsContainer.classList.remove('show');
                        return;
                }
                
                // 更新选中状态
                options.forEach((option, index) => {
                    option.classList.toggle('selected', index === newIndex);
                });
                
                // 滚动到选中的选项
                if (newIndex >= 0 && options[newIndex]) {
                    options[newIndex].scrollIntoView({ block: 'nearest' });
                }
            });
        }
        
        // 筛选厂商
function filterManufacturers(searchTerm) {
    const optionsContainer = document.getElementById('manufacturerOptions');
    const term = searchTerm.toLowerCase();
    
    // 筛选匹配的厂商
    filteredManufacturers = manufacturerData.filter(manufacturer => {
        const nameZh = (manufacturer.nameZh || '').toLowerCase();
        const nameEn = (manufacturer.nameEn || '').toLowerCase();
        const name = (manufacturer.name || '').toLowerCase();
        
        return nameZh.includes(term) || nameEn.includes(term) || name.includes(term);
    });
    
    // 更新选项显示
    optionsContainer.innerHTML = '';
    
    // 在新增模式下，如果搜索词为空或匹配"未知开发商"，添加未知开发商选项
    if (formMode === 'add' && (!term || '未知开发商'.toLowerCase().includes(term))) {
        const unknownOption = document.createElement('div');
        unknownOption.className = 'option-item';
        unknownOption.dataset.value = '1';
        unknownOption.textContent = '未知开发商';
        optionsContainer.appendChild(unknownOption);
    }
    
    if (filteredManufacturers.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'option-item';
        noResult.textContent = '未找到匹配的厂商';
        noResult.style.fontStyle = 'italic';
        noResult.style.color = '#999';
        optionsContainer.appendChild(noResult);
    } else {
        filteredManufacturers.forEach(manufacturer => {
            // 在新增模式下跳过未知开发商（避免重复显示）
            if (formMode === 'add' && manufacturer.id === 1) return;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.dataset.value = manufacturer.id;
            optionItem.textContent = manufacturer.nameZh && manufacturer.nameEn ? 
                `${manufacturer.nameZh}(${manufacturer.nameEn})` : 
                (manufacturer.nameZh || manufacturer.nameEn || manufacturer.name || '未知厂商');
            optionsContainer.appendChild(optionItem);
        });
    }
}
        
        // 处理厂商选择变化
        function handleManufacturerChange() {
            const manufacturerSelect = document.getElementById('manufacturer');
            const selectedManufacturerId = parseInt(manufacturerSelect.value);
            const selectedManufacturer = manufacturerData.find(m => m.id === selectedManufacturerId);
            
            if (selectedManufacturer && selectedManufacturer.country_id) {
                console.log('Selected manufacturer country ID:', selectedManufacturer.country_id);
            }
        }

        // 获取行业大类列表
        async function fetchIndustryCategories() {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/categories`);
                if (!response.ok) throw new Error('获取行业大类列表失败');
                const result = await response.json();
                
                industryCategories = Array.isArray(result.categories) ? result.categories : [];
                
                // 为每个大类预加载小类
                for (const category of industryCategories) {
                    await fetchIndustrySubcategories(category.categoryCode);
                }
                
                // 构建树状结构
                buildIndustryTree();
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('获取行业大类列表错误:', error);
            }
        }

        // 获取行业小类列表
        async function fetchIndustrySubcategories(categoryCode) {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/categories/${categoryCode}/subcategories`);
                if (!response.ok) throw new Error('获取行业小类列表失败');
                const result = await response.json();
                
                const data = Array.isArray(result.subcategories) ? result.subcategories : [];
                industrySubcategories.set(categoryCode, data);
            } catch (error) {
                console.error('获取行业小类列表错误:', error);
            }
        }

        // 构建行业分类树状结构
        function buildIndustryTree() {
            const treeContent = document.getElementById('industryTreeContent');
            treeContent.innerHTML = '';
            
            industryCategories.forEach(category => {
                // 创建大类节点
                const categoryNode = document.createElement('div');
                categoryNode.className = 'tree-node parent';
                categoryNode.dataset.categoryCode = category.categoryCode;
                
                const categoryContent = document.createElement('div');
                categoryContent.className = 'node-content';
                categoryContent.innerHTML = `
                    ${category.categoryName}
                `;
                
                categoryNode.appendChild(categoryContent);
                
                // 创建小类容器
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-node-children';
                
                // 创建小类网格容器
                const subcategoryGrid = document.createElement('div');
                subcategoryGrid.className = 'subcategory-grid';
                
                // 添加小类
                const subcategories = industrySubcategories.get(category.categoryCode) || [];
                subcategories.forEach(subcategory => {
                    const subcategoryNode = document.createElement('div');
                    subcategoryNode.className = 'tree-node';
                    subcategoryNode.dataset.categoryCode = category.categoryCode;
                    subcategoryNode.dataset.subcategoryId = subcategory.id;
                    subcategoryNode.textContent = `${subcategory.subcategoryName} (${subcategory.subcategoryCode})`;
                    subcategoryGrid.appendChild(subcategoryNode);
                });
                
                childrenContainer.appendChild(subcategoryGrid);
                categoryNode.appendChild(childrenContainer);
                treeContent.appendChild(categoryNode);
                
                // 添加事件监听器
                categoryContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleCategoryNode(categoryNode);
                });
                
                // 为小类节点添加事件监听器
                subcategoryGrid.querySelectorAll('.tree-node').forEach(node => {
                    node.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const categoryCode = node.dataset.categoryCode;
                        const subcategoryId = parseInt(node.dataset.subcategoryId);
                        
                        // 获取大类信息
                        const category = industryCategories.find(c => c.categoryCode === categoryCode);
                        const categoryName = category ? category.categoryName : '';
                        
                        // 获取小类信息
                        const subcategories = industrySubcategories.get(categoryCode) || [];
                        const subcategory = subcategories.find(s => s.id === subcategoryId);
                        const subcategoryName = subcategory ? `${subcategory.subcategoryName} (${subcategory.subcategoryCode})` : '';
                        
                        // 切换小类选择状态
                        toggleSubcategorySelection(
                            categoryCode, 
                            categoryName,
                            subcategoryId,
                            subcategoryName,
                            !node.classList.contains('selected') // 反转当前选择状态
                        );
                    });
                });
            });
            
            // 根据小类数量调整下拉框高度
            adjustTreeDropdownHeight();
        }
        
        // 根据小类数量调整下拉框高度
        function adjustTreeDropdownHeight() {
            const treeContent = document.getElementById('industryTreeContent');
            const dropdown = document.getElementById('industryTreeDropdown');
            
            // 计算总的小类数量
            let totalSubcategories = 0;
            industryCategories.forEach(category => {
                const subcategories = industrySubcategories.get(category.categoryCode) || [];
                totalSubcategories += subcategories.length;
            });
            
            // 根据小类数量调整高度，每个小类大约30px高度
            const estimatedHeight = totalSubcategories * 30;
            
            // 限制最大高度为300px，最小高度为150px
            const adjustedHeight = Math.min(Math.max(estimatedHeight, 150), 650);
            dropdown.style.maxHeight = adjustedHeight + 'px';
        }
        
        // 更新小类节点UI状态
        function updateSubcategoryNodeUI(categoryCode, subcategoryId, selected) {
            const treeContent = document.getElementById('industryTreeContent');
            const node = treeContent.querySelector(`.tree-node[data-category-code="${categoryCode}"][data-subcategory-id="${subcategoryId}"]`);
            
            if (node) {
                if (selected) {
                    node.classList.add('selected');
                    node.style.backgroundColor = '#e6f3ff';
                } else {
                    node.classList.remove('selected');
                    node.style.backgroundColor = '';
                }
            }
        }

        // 切换大类节点展开/收起
        function toggleCategoryNode(node) {
            node.classList.toggle('expanded');
            const children = node.querySelector('.tree-node-children');
            children.classList.toggle('show');
        }

        // 切换大类选择
        function toggleCategorySelection(categoryCode, categoryName, selected) {
            // 如果选择大类，则选择所有小类
            if (selected) {
                if (!selectedIndustries.has(categoryCode)) {
                    selectedIndustries.set(categoryCode, {
                        categoryName: categoryName,
                        subcategories: new Map()
                    });
                }
                
                const categoryData = selectedIndustries.get(categoryCode);
                
                // 选择所有小类
                const subcategories = industrySubcategories.get(categoryCode) || [];
                subcategories.forEach(sub => {
                    categoryData.subcategories.set(sub.id, `${sub.subcategoryName} (${sub.subcategoryCode})`);
                });
            } else {
                // 如果取消选择大类，则取消选择所有小类
                selectedIndustries.delete(categoryCode);
            }
            
            // 更新UI
            updateIndustrySelectionUI();
            updateIndustryTreeCheckboxes();
        }

        // 切换小类选择
        function toggleSubcategorySelection(categoryCode, categoryName, subcategoryId, subcategoryName, selected) {
            // 确保大类条目存在
            if (!selectedIndustries.has(categoryCode)) {
                selectedIndustries.set(categoryCode, {
                    categoryName: categoryName,
                    subcategories: new Map()
                });
            }
            
            const categoryData = selectedIndustries.get(categoryCode);
            
            if (selected) {
                // 添加小类
                categoryData.subcategories.set(subcategoryId, subcategoryName);
                
                // 更新UI状态
                updateSubcategoryNodeUI(categoryCode, subcategoryId, true);
            } else {
                // 移除小类
                categoryData.subcategories.delete(subcategoryId);
                
                // 更新UI状态
                updateSubcategoryNodeUI(categoryCode, subcategoryId, false);
                
                // 如果该大类下没有小类了，则移除大类
                if (categoryData.subcategories.size === 0) {
                    selectedIndustries.delete(categoryCode);
                }
            }
            
            // 更新UI
            updateIndustrySelectionUI();
        }

        // 更新行业分类选择UI
        function updateIndustrySelectionUI() {
            const container = document.getElementById('selectedIndustriesContainer');
            container.innerHTML = '';
            
            let hasSelection = false;
            
            // 遍历所有已选择的行业
            for (const [categoryCode, categoryData] of selectedIndustries.entries()) {
                if (categoryData.subcategories.size > 0) {
                    hasSelection = true;
                    
                    // 为每个小类创建标签
                    for (const [subcategoryId, subcategoryName] of categoryData.subcategories.entries()) {
                        const tag = document.createElement('div');
                        tag.className = 'selected-industry-tag';
                        tag.innerHTML = `
                            ${categoryData.categoryName}: ${subcategoryName}
                            <span class="remove-tag" data-category="${categoryCode}" data-id="${subcategoryId}">×</span>
                        `;
                        
                        // 添加删除事件
                        tag.querySelector('.remove-tag').addEventListener('click', function() {
                            removeIndustryTag(categoryCode, subcategoryId);
                        });
                        
                        container.appendChild(tag);
                    }
                }
            }
            
            // 如果没有选择，显示提示文字
            if (!hasSelection) {
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder-text';
                placeholder.textContent = '请选择行业分类';
                container.appendChild(placeholder);
            }
        }

        // 更新树状选择器中的复选框状态
        function updateIndustryTreeCheckboxes() {
            // 更新大类复选框
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                const categoryCode = checkbox.dataset.categoryCode;
                const categoryData = selectedIndustries.get(categoryCode);
                
                if (categoryData && categoryData.subcategories.size > 0) {
                    // 检查是否选择了所有小类
                    const totalSubcategories = industrySubcategories.get(categoryCode) || [];
                    checkbox.checked = categoryData.subcategories.size === totalSubcategories.length && totalSubcategories.length > 0;
                    checkbox.indeterminate = categoryData.subcategories.size > 0 && categoryData.subcategories.size < totalSubcategories.length;
                } else {
                    checkbox.checked = false;
                    checkbox.indeterminate = false;
                }
            });
            
            // 更新小类复选框
            document.querySelectorAll('.subcategory-checkbox').forEach(checkbox => {
                const categoryCode = checkbox.dataset.categoryCode;
                const subcategoryId = parseInt(checkbox.dataset.subcategoryId);
                const categoryData = selectedIndustries.get(categoryCode);
                
                checkbox.checked = categoryData && categoryData.subcategories.has(subcategoryId);
            });
        }

        // 删除行业标签
        function removeIndustryTag(categoryCode, subcategoryId) {
            const categoryData = selectedIndustries.get(categoryCode);
            if (categoryData) {
                // 移除小类
                categoryData.subcategories.delete(subcategoryId);
                
                // 如果该大类下没有小类了，则移除大类
                if (categoryData.subcategories.size === 0) {
                    selectedIndustries.delete(categoryCode);
                }
                
                // 更新UI
                updateIndustrySelectionUI();
                updateIndustryTreeCheckboxes();
            }
        }

        // 清空行业选择
        function clearIndustrySelection() {
            selectedIndustries.clear();
            updateIndustrySelectionUI();
            updateIndustryTreeCheckboxes();
        }

        // 切换行业分类树状选择器
        function toggleIndustryTree() {
            const dropdown = document.getElementById('industryTreeDropdown');
            dropdown.classList.toggle('show');
        }

        // 选择常用行业分类
        function selectQuickIndustry(categoryCode, subcategoryCode) {
            // 查找行业分类数据
            const category = industryCategories.find(c => c.categoryCode === categoryCode);
            if (!category) {
                showMessage('未找到对应的行业大类', 'error');
                return;
            }
            
            const subcategories = industrySubcategories.get(categoryCode) || [];
            const subcategory = subcategories.find(s => s.subcategoryCode === subcategoryCode);
            if (!subcategory) {
                showMessage('未找到对应的行业小类', 'error');
                return;
            }
            
            // 检查是否已经选中
            const isCurrentlySelected = selectedIndustries.has(categoryCode) && 
                selectedIndustries.get(categoryCode).subcategories.has(subcategory.id);
            
            if (isCurrentlySelected) {
                // 如果已选中，则取消选择
                toggleSubcategorySelection(
                    categoryCode,
                    category.categoryName,
                    subcategory.id,
                    `${subcategory.subcategoryName} (${subcategory.subcategoryCode})`,
                    false // 取消选择状态
                );
                showMessage(`已取消选择 ${category.categoryName} - ${subcategory.subcategoryName}`, 'success');
            } else {
                // 如果未选中，则选择
                toggleSubcategorySelection(
                    categoryCode,
                    category.categoryName,
                    subcategory.id,
                    `${subcategory.subcategoryName} (${subcategory.subcategoryCode})`,
                    true // 选择状态
                );
                showMessage(`已选择 ${category.categoryName} - ${subcategory.subcategoryName}`, 'success');
            }
        }
        
        // 绑定常用行业分类快捷按键事件
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('industry-quick-btn')) {
                const categoryCode = e.target.dataset.categoryCode;
                const subcategoryCode = e.target.dataset.subcategoryCode;
                selectQuickIndustry(categoryCode, subcategoryCode);
            }
        });

        // 加载软件数据（仅在编辑模式下使用）
        async function loadSoftwareData(id) {
            try {
                const response = await fetch(`${window.Config.API_BASE_URL}/software/${id}`);
                if (!response.ok) throw new Error('获取软件数据失败');
                
                const software = await response.json();
                
                // 填充表单数据
                document.getElementById('nameEn').value = software.nameEn || '';
                document.getElementById('nameZh').value = software.nameZh || '';
                document.getElementById('version').value = software.version || '';
                
                // 填充发布日期
                if (software.releaseYear) {
                    document.getElementById('releaseYear').value = software.releaseYear;
                }
                if (software.releaseMonth) {
                    document.getElementById('releaseMonth').value = software.releaseMonth;
                }
                if (software.releaseDay) {
                    document.getElementById('releaseDay').value = software.releaseDay;
                }
                
                // 填充厂商
                if (software.developerId) {
                    document.getElementById('manufacturer').value = software.developerId;
                    
                    // 更新搜索框显示
                    const selectedManufacturer = manufacturerData.find(m => m.id === software.developerId);
                    if (selectedManufacturer) {
                        const displayName = selectedManufacturer.nameZh && selectedManufacturer.nameEn ? 
                            `${selectedManufacturer.nameZh}(${selectedManufacturer.nameEn})` : 
                            (selectedManufacturer.nameZh || selectedManufacturer.nameEn || selectedManufacturer.name || '未知厂商');
                        document.getElementById('manufacturerSearch').value = displayName;
                    }
                }
                
                // 转换并填充软件大小
                if (software.sizeBytes) {
                    const sizeData = convertBytesToUnits(software.sizeBytes);
                    document.getElementById('sizeValue').value = sizeData.value;
                    document.getElementById('sizeUnit').value = sizeData.unit;
                }
                
                // 填充其他字段
                document.getElementById('cpuReq').value = software.cpuReq || '';
                document.getElementById('memoryMin').value = software.memoryMinGb || '';
                document.getElementById('diskMin').value = software.diskMinGb || '';
                document.getElementById('sysReqOther').value = software.sysReqOther || '';
                document.getElementById('description').value = software.description || '';
                document.getElementById('sourceUrl').value = software.sourceUrl || '';
                document.getElementById('downloadLink').value = software.downloadLink || '';
                document.getElementById('deploymentMethod').value = software.deploymentMethod || '';
                document.getElementById('complianceInfo').value = software.complianceInfo || '';
                document.getElementById('securityInfo').value = software.securityInfo || '';
                document.getElementById('intellectualProperty').value = software.intellectualProperty || '';
                document.getElementById('status').value = software.status || 'active';
                
                // 处理行业分类数据 - 从industryDetails字段获取数据
                if (Array.isArray(software.industryDetails)) {
                    // 清空当前选择
                    selectedIndustries.clear();
                    
                    // 重新构建选择的行业分类
                    software.industryDetails.forEach(industry => {
                        // 从industryDetails中获取行业信息
                        const categoryCode = industry.categoryCode;
                        const subcategoryId = industry.id;
                        const categoryName = industry.categoryName;
                        const subcategoryName = `${industry.subcategoryName} (${industry.subcategoryCode})`;
                        
                        // 确保大类条目存在
                        if (!selectedIndustries.has(categoryCode)) {
                            selectedIndustries.set(categoryCode, {
                                categoryName: categoryName,
                                subcategories: new Map()
                            });
                        }
                        
                        // 添加小类
                        const categoryData = selectedIndustries.get(categoryCode);
                        categoryData.subcategories.set(subcategoryId, subcategoryName);
                    });
                    
                    // 更新UI
                    updateIndustrySelectionUI();
                    updateIndustryTreeCheckboxes();
                }

                // 处理操作系统数据 - 修正后移到try块内
                if (Array.isArray(software.osIds)) {
                    const windowsSelect = document.getElementById('windowsOSIds');
                    const otherSelect = document.getElementById('otherOSIds');
                    
                    // 清空之前的选择
                    Array.from(windowsSelect.options).forEach(option => option.selected = false);
                    Array.from(otherSelect.options).forEach(option => option.selected = false);
                    
                    // 重新渲染选项
                    renderOSOptions();
                    
                    // 选择对应的操作系统
                    software.osIds.forEach(osId => {
                        // 在Windows列表中查找
                        let option = windowsSelect.querySelector(`option[value="${osId}"]`);
                        if (option) {
                            option.selected = true;
                        } else {
                            // 在其他系统列表中查找
                            option = otherSelect.querySelector(`option[value="${osId}"]`);
                            if (option) {
                                option.selected = true;
                            }
                        }
                    });
                }

                // 加载位宽数据
                if (Array.isArray(software.bitWidths)) {
                    const bitWidthTags = document.querySelectorAll('.bit-width-tag');
                    bitWidthTags.forEach(tag => {
                        if (software.bitWidths.includes(tag.dataset.value)) {
                            tag.classList.add('selected');
                        }
                    });
                }
        } catch (error) {
            showMessage(error.message, 'error');
            console.error('加载软件数据错误:', error);
        }
        }

        // 将字节转换为合适的单位
        function convertBytesToUnits(bytes) {
            if (bytes >= 1024 * 1024 * 1024) {
                return { value: (bytes / (1024 * 1024 * 1024)).toFixed(2), unit: 'GB' };
            } else if (bytes >= 1024 * 1024) {
                return { value: (bytes / (1024 * 1024)).toFixed(2), unit: 'MB' };
            } else if (bytes >= 1024) {
                return { value: (bytes / 1024).toFixed(2), unit: 'KB' };
            } else {
                return { value: bytes, unit: 'GB' }; // 默认返回字节
            }
        }

        // 处理表单提交
        async function handleSubmit(event) {
            event.preventDefault();

            // 获取所有选中的行业小类ID
            let allSelectedSubcategories = [];
            for (const [categoryCode, categoryData] of selectedIndustries.entries()) {
                for (const subcategoryId of categoryData.subcategories.keys()) {
                    allSelectedSubcategories.push(subcategoryId);
                }
            }
            
            // 获取软件大小
            const sizeValue = document.getElementById('sizeValue').value;
            const sizeUnit = document.getElementById('sizeUnit').value;
            let sizeBytes = null;
            
            if (sizeValue) {
                const sizeNum = parseFloat(sizeValue);
                switch (sizeUnit) {
                    case 'GB':
                        sizeBytes = Math.round(sizeNum * 1024 * 1024 * 1024); // GB to bytes
                        break;
                    case 'MB':
                        sizeBytes = Math.round(sizeNum * 1024 * 1024); // MB to bytes
                        break;
                    case 'KB':
                        sizeBytes = Math.round(sizeNum * 1024); // KB to bytes
                        break;
                    default:
                        sizeBytes = Math.round(sizeNum); // bytes
                }
            }

            // 获取发布日期字段
            const releaseYear = document.getElementById('releaseYear').value;
            const releaseMonth = document.getElementById('releaseMonth').value;
            const releaseDay = document.getElementById('releaseDay').value;
            
            // 验证发布日期
            let releaseDate = null;
            if (releaseYear) {
                if (!/^\d{4}$/.test(releaseYear)) {
                    showMessage('请输入有效的年份(4位数字)', 'error');
                    return;
                }
                
                if (releaseMonth && !/^\d{1,2}$/.test(releaseMonth)) {
                    showMessage('请输入有效的月份(1-12)', 'error');
                    return;
                }
                
                if (releaseDay && !/^\d{1,2}$/.test(releaseDay)) {
                    showMessage('请输入有效的日期(1-31)', 'error');
                    return;
                }
                
                // 构建日期字符串
                if (releaseMonth && releaseDay) {
                    // 完整日期
                    const month = releaseMonth.padStart(2, '0');
                    const day = releaseDay.padStart(2, '0');
                    releaseDate = `${releaseYear}-${month}-${day}`;
                    
                    // 验证日期有效性
                    const date = new Date(releaseDate);
                    if (date instanceof Date && !isNaN(date)) {
                        // 确保日期与输入一致（防止自动调整）
                        if (date.getFullYear() != releaseYear || date.getMonth() + 1 != releaseMonth || date.getDate() != releaseDay) {
                            showMessage('请输入有效的日期', 'error');
                            return;
                        }
                    } else {
                        showMessage('请输入有效的日期', 'error');
                        return;
                    }
                } else if (releaseMonth) {
                    // 只有年和月
                    const month = releaseMonth.padStart(2, '0');
                    releaseDate = `${releaseYear}-${month}`;
                } else {
                    // 只有年
                    releaseDate = releaseYear;
                }
            }
            
            // 查找选中的厂商信息
            const manufacturerSelect = document.getElementById('manufacturer');
            const selectedManufacturerId = parseInt(manufacturerSelect.value);
            const selectedManufacturer = manufacturerData.find(m => m.id === selectedManufacturerId);
            
            // 获取选中的操作系统ID
            const windowsSelect = document.getElementById('windowsOSIds');
            const otherSelect = document.getElementById('otherOSIds');
            const selectedWindowsOSIds = Array.from(windowsSelect.selectedOptions).map(option => parseInt(option.value));
            const selectedOtherOSIds = Array.from(otherSelect.selectedOptions).map(option => parseInt(option.value));
            const selectedOSIds = [...selectedWindowsOSIds, ...selectedOtherOSIds];

            // 构建数据对象
            const formData = {
                nameEn: document.getElementById('nameEn').value,
                nameZh: document.getElementById('nameZh').value,
                version: document.getElementById('version').value,
                // 从选中的厂商信息中获取国家ID
                countryId: selectedManufacturer ? selectedManufacturer.countryId : null,
                developerId: selectedManufacturerId,
                release_date: releaseDate,
                release_year: releaseYear ? parseInt(releaseYear) : null,
                release_month: releaseMonth ? parseInt(releaseMonth) : null,
                release_day: releaseDay ? parseInt(releaseDay) : null,
                cpu_req: document.getElementById('cpuReq').value || null,
                memory_min_gb: document.getElementById('memoryMin').value ? parseFloat(document.getElementById('memoryMin').value) : null,
                disk_min_gb: document.getElementById('diskMin').value ? parseFloat(document.getElementById('diskMin').value) : null,
                sys_req_other: document.getElementById('sysReqOther').value || null,
                description: document.getElementById('description').value || null,
                size_bytes: sizeBytes, 
                industry_ids: allSelectedSubcategories,
                os_ids: selectedOSIds,
                source_url: document.getElementById('sourceUrl').value || null,
                download_link: document.getElementById('downloadLink').value || null,
                deployment_method: document.getElementById('deploymentMethod').value || null,
                compliance_info: document.getElementById('complianceInfo').value || null,
                security_info: document.getElementById('securityInfo').value || null,
                intellectual_property: document.getElementById('intellectualProperty').value || null,
                status: document.getElementById('status').value,
                bit_widths: Array.from(document.querySelectorAll('.bit-width-tag.selected')).map(tag => tag.dataset.value)
            };

            // 验证必填字段
            if (!formData.nameEn || !formData.version || !formData.countryId || !formData.developerId || !formData.status || allSelectedSubcategories.length === 0) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }

            try {
                let response;
                
                // 根据操作模式选择不同的API端点和方法
                if (formMode === 'add') {
                    response = await fetch(`${window.Config.API_BASE_URL}/software`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${window.Config.API_BASE_URL}/software/${softwareId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || (formMode === 'add' ? '添加失败，请重试' : '更新失败，请重试'));
                }

                showMessage(formMode === 'add' ? '工业软件添加成功！' : '工业软件更新成功！', 'success');
                
                // 在新增模式下重置表单
                if (formMode === 'add') {
                    document.getElementById('softwareForm').reset();
                    
                    // 重置行业分类选择
                    selectedIndustries.clear();
                    updateIndustrySelectionUI();
                    updateIndustryTreeCheckboxes();
                    
                    // 重置选择框为默认选项
                    document.getElementById('manufacturer').innerHTML = '<option value="1" selected>未知开发商</option>';
                    
                    // 重新加载厂商列表
                    fetchManufacturers();
                    fetchIndustryCategories();
                }
            } catch (error) {
                showMessage(error.message, 'error');
                console.error('提交表单错误:', error);
            }
        }

        // 清空操作系统选择
        function clearOS() {
            const windowsSelect = document.getElementById('windowsOSIds');
            const otherSelect = document.getElementById('otherOSIds');
            
            Array.from(windowsSelect.options).forEach(option => option.selected = false);
            Array.from(otherSelect.options).forEach(option => option.selected = false);
            
            showMessage('已清空操作系统选择', 'success');
        }

        document.getElementById('clearOSBtn').addEventListener('click', clearOS);

        function clearByBitWidth(bitWidth) {
            const windowsSelect = document.getElementById('windowsOSIds');
            let clearedX86Count = 0;
            let clearedX64Count = 0;

            Array.from(windowsSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                if (bitWidth === '32') { 
                    if (text.includes('x86')) {
                        if (option.selected) {
                            option.selected = false;
                            clearedX86Count++;
                        }
                    }
                } else if (bitWidth === '64') {
                    if (text.includes('x64')) {
                        if (option.selected) {
                            option.selected = false;
                            clearedX64Count++;
                        }
                    }
                }
            });
            
            if (bitWidth === '32') { 
                 if (clearedX86Count > 0) {
                    showMessage(`已清理${clearedX86Count}个32位操作系统选项`, 'success');
                } else {
                    showMessage('没有选中的32位操作系统选项', 'info');
                }
            }
            
            if (bitWidth === '64') {
                if (clearedX64Count > 0) {
                    showMessage(`已清理${clearedX64Count}个64位操作系统选项`, 'success');
                } else {
                    showMessage('没有选中的64位操作系统选项', 'info');
                }
            }
        }
        // 清理32位操作系统选项
        function clearX86() {
            clearByBitWidth('32');
        }
        // 清理64位操作系统选项
        function clearX64() {
            clearByBitWidth('64');
        }
        document.getElementById('clearX86Btn').addEventListener('click', clearX86);
        document.getElementById('clearX64Btn').addEventListener('click', clearX64);

        // 选择所有Windows
        function selectAllWindows() {
            const windowsSelect = document.getElementById('windowsOSIds');
            Array.from(windowsSelect.options).forEach(option => {
                option.selected = true;
            });
        }

        document.getElementById('selectAllWindowsBtn').addEventListener('click', selectAllWindows);

        // 通过位宽选择 32或64位
        function selectWinByBitWidth(bitWidth) {
            const windowsSelect = document.getElementById('windowsOSIds');
            let hasNewSelection = false;
            
            Array.from(windowsSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                const alreadySelected = option.selected;
                
                if (bitWidth === '32') {
                    if (text.includes('x86') || text.includes('32-bit') || text.includes('32位')) {
                        option.selected = true;
                        if (!alreadySelected) hasNewSelection = true;
                    }
                } else if (bitWidth === '64') {
                    if (text.includes('x64') || text.includes('64-bit') || text.includes('64位')) {
                        option.selected = true;
                        if (!alreadySelected) hasNewSelection = true;
                    }
                }
            });
        }
        // 32位系统选择函数
        function selectWin32() {
            selectWinByBitWidth('32');
        }
        // 64位系统选择函数
        function selectWin64() {
            selectWinByBitWidth('64');
        }
        document.getElementById('selectWin32Btn').addEventListener('click', selectWin32);
        document.getElementById('selectWin64Btn').addEventListener('click', selectWin64);

        // 选择Windows XP及以上系统功能
        function selectWinXPAndAbove() {
            const windowsSelect = document.getElementById('windowsOSIds');
            Array.from(windowsSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                // 选择Windows XP及以上版本
                if (text.includes('windows') && 
                    (text.includes('xp') || text.includes('vista') || 
                    text.includes('7 ') || text.includes('8 ') || text.includes('10') || text.includes('11') ||
                    text.includes('server 2008') || text.includes('server 2012') || 
                    text.includes('server 2016') || text.includes('server 2019') || text.includes('server 2022'))) {
                    option.selected = true;
                }
            });
        }
        document.getElementById('selectWinXPAndAboveBtn').addEventListener('click', selectWinXPAndAbove);

        // 根据版本选择win 
        function selectWinByVersion(version) {
            const windowsSelect = document.getElementById('windowsOSIds');
            let hasNewSelection = false;
            
            Array.from(windowsSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                
                if (version === 'NT') {
                    if (text.includes('windows nt')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '95') {
                    if (text.includes('windows 95')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '98') {
                    if (text.includes('windows 98')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '2000') {
                    if (text.includes('windows 2000')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'XP') {
                    if (text.includes('windows xp')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'Vista') {
                    if (text.includes('windows vista')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                }else if (version === '7') {
                    if (text.includes('windows 7')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '8') {
                    if (text.includes('windows 8')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '10') {
                    if (text.includes('windows 10')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === '11') {
                    if (text.includes('windows 11')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                }
            });
        }

        // 选择Windows NT
        function selectWinNT() {
            selectWinByVersion('NT');
        }
        document.getElementById('selectWinNTBtn').addEventListener('click', selectWinNT);
        // 选择Windows 95
        function selectWin95() {
            selectWinByVersion('95');
        }
        document.getElementById('selectWin95Btn').addEventListener('click', selectWin95);
        // 选择Windows 98
        function selectWin98() {
            selectWinByVersion('98');
        }
        document.getElementById('selectWin98Btn').addEventListener('click', selectWin98);
        // 选择Windows 2000
        function selectWin2000() {
            selectWinByVersion('2000');
        }
        document.getElementById('selectWin2000Btn').addEventListener('click', selectWin2000);
        // 选择Windows XP系统
        function selectWinXP() {
            selectWinByVersion('XP');
        }
        document.getElementById('selectWinXPBtn').addEventListener('click', selectWinXP);
        // 选择Windows Vista系统功能
        function selectWinVista() {
            selectWinByVersion('Vista');
        }
        document.getElementById('selectWinVistaBtn').addEventListener('click', selectWinVista);
        // 选择Windows 7系统功能
        function selectWin7() {
            selectWinByVersion('7');
        }
        document.getElementById('selectWin7Btn').addEventListener('click', selectWin7);
        // 选择Windows 8系统
        function selectWin8() {
            selectWinByVersion('8');
        }
        document.getElementById('selectWin8Btn').addEventListener('click', selectWin8);
        // 选择Windows 10系统
        function selectWin10() {
            selectWinByVersion('10');
        }
        document.getElementById('selectWin10Btn').addEventListener('click', selectWin10);
        // 选择Windows 11系统
        function selectWin11() {
            selectWinByVersion('11');
        }
        document.getElementById('selectWin11Btn').addEventListener('click', selectWin11);

        // 选择所有Linux系统
        function selectAllLinux() {
            const otherSelect = document.getElementById('otherOSIds');
            Array.from(otherSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                if (text.includes('ubuntu') || text.includes('centos') || 
                    text.includes('linux') || text.includes('red hat') || 
                    text.includes('debian') || text.includes('fedora') ||
                    text.includes('suse')) {
                    option.selected = true;
                }
            });
            showMessage('已选择所有Linux系统', 'success');
        }

        document.getElementById('selectAllLinuxBtn').addEventListener('click', selectAllLinux);

        // 根据版本选择 其他系统
        function selectOtherOSByVersion(version) {
            const otherSelect = document.getElementById('otherOSIds');
            let hasNewSelection = false;
            
            Array.from(otherSelect.options).forEach(option => {
                const text = option.text.toLowerCase();
                
                if (version === 'Ubuntu') {
                    if (text.includes('ubuntu')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'CentOS') {
                    if (text.includes('centos')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'RedHat') {
                    if (text.includes('red hat')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'Fedora') {
                    if (text.includes('fedora')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'SUSE') {
                    if (text.includes('suse')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'Debian') {
                    if (text.includes('debian')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'MacOS') {
                    if (text.includes('macos')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'Android') {
                    if (text.includes('android')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                } else if (version === 'Access') {
                    if (text.includes('access')) {
                        option.selected = !option.selected;
                        hasNewSelection = true;
                    }
                }
            });
        }
        // 选择Ubuntu
        function selectUbuntu() {
            selectOtherOSByVersion('Ubuntu');
        }
        document.getElementById('selectUbuntuBtn').addEventListener('click', selectUbuntu);
        // 选择Centos
        function selectCentOS() {
            selectOtherOSByVersion('CentOS');
        }
        document.getElementById('selectCentOSBtn').addEventListener('click', selectCentOS);
        // 选择RedHat
        function selectRedHat() {
            selectOtherOSByVersion('RedHat');
        }
        document.getElementById('selectRedHatBtn').addEventListener('click', selectRedHat);
        // 选择Fedora
        function selectFedora() {
            selectOtherOSByVersion('Fedora');
        }
        document.getElementById('selectFedoraBtn').addEventListener('click', selectFedora);
        // 选择SUSE
        function selectSUSE() {
            selectOtherOSByVersion('SUSE');
        }
        document.getElementById('selectSUSEBtn').addEventListener('click', selectSUSE);
        // 选择Debian
        function selectDebian() {
            selectOtherOSByVersion('Debian');
        }
        document.getElementById('selectDebianBtn').addEventListener('click', selectDebian);
        // 选择MacOS
        function selectMacOS() {
            selectOtherOSByVersion('MacOS');
        }
        document.getElementById('selectMacOSBtn').addEventListener('click', selectMacOS);
        // 选择Android
        function selectAndroid() {
            selectOtherOSByVersion('Android');
        }
        document.getElementById('selectAndroidBtn').addEventListener('click', selectAndroid);
        // 选择Access
        function selectAccess() {
            selectOtherOSByVersion('Access');
        }
        document.getElementById('selectAccessBtn').addEventListener('click', selectAccess);


        // 处理取消操作
        function handleCancel() {
            if (formMode === 'add') {
                if (confirm('确定要取消添加工业软件吗？未保存的数据将会丢失。')) {
                    document.getElementById('softwareForm').reset();
                    
                    // 重置行业分类选择
                    selectedIndustries.clear();
                    updateIndustrySelectionUI();
                    updateIndustryTreeCheckboxes();
                    
                    // 重置选择框为默认选项
                    document.getElementById('manufacturer').innerHTML = '<option value="1" selected>未知开发商</option>';
                    
                    // 清除消息
                    document.getElementById('message').className = 'message';
                    document.getElementById('message').textContent = '';
                    
                    // 重新加载厂商列表
                    fetchManufacturers();
                    fetchIndustryCategories();
                }
            } else {
                // 编辑模式下直接跳转回列表页面
                // 从URL获取软件ID
                const urlParams = new URLSearchParams(window.location.search);
                const softwareId = urlParams.get('id');
                
                if (softwareId) {
                    // 使用软件ID作为newSoftwareId参数跳转到软件列表页面
                    window.location.href = `software_list.html?newSoftwareId=${softwareId}`;
                } else {
                    // 如果没有软件ID，则直接跳转到软件列表页面
                    window.location.href = 'software_list.html';
                }
            }
        }

        // 显示消息
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;

            // 3秒后自动清除消息
            setTimeout(() => {
                messageEl.textContent = '';
                messageEl.className = 'message';
            }, 3000);
        }

        // 返回链接点击事件处理
        document.getElementById('backLink').addEventListener('click', function(e) {
            e.preventDefault(); // 阻止默认的链接跳转行为
            
            // 从URL获取软件ID
            const urlParams = new URLSearchParams(window.location.search);
            const softwareId = urlParams.get('id');
            
            if (softwareId) {
                // 使用软件ID作为newSoftwareId参数跳转到软件列表页面
                window.location.href = `software_list.html?newSoftwareId=${softwareId}`;
            } else {
                // 如果没有软件ID，则直接跳转到软件列表页面
                window.location.href = 'software_list.html';
            }
        });
    </script>
</body>
</html>